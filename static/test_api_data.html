<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB API 數據測試頁面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 15px;
            padding: 5px 15px;
            background-color: #f7fafc;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background-color: #48bb78;
        }
        
        .status-indicator.disconnected {
            background-color: #f56565;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .data-section h2 {
            margin-top: 0;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .data-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .position-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .position-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .position-symbol {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .position-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table td {
            padding: 5px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .data-table td:first-child {
            font-weight: 500;
            color: #4a5568;
            width: 40%;
        }
        
        .data-table td:last-child {
            text-align: right;
            color: #2d3748;
        }
        
        .section-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #4a5568;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 16px;
            transition: color 0.3s ease;
        }
        
        .back-link:hover {
            color: #5a67d8;
            text-decoration: underline;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .summary-card h3 {
            margin: 0 0 5px 0;
            color: #718096;
            font-size: 14px;
            font-weight: normal;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .greeks-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .greek-item {
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .greek-item .label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }
        
        .greek-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .highlight {
            background-color: #fff3cd;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .status-good {
            color: #198754;
        }

        .status-bad {
            color: #dc3545;
        }

        .api-methods {
            background-color: #e7f3ff;
            border: 1px solid #b6d4fe;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .method-item {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.25rem;
        }

        .expandable {
            cursor: pointer;
            user-select: none;
        }

        .expandable:hover {
            background-color: #f0f0f0;
        }

        .collapsed {
            display: none;
        }

        .json-viewer {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .json-key {
            color: #63b3ed;
        }

        .json-string {
            color: #68d391;
        }

        .json-number {
            color: #f6ad55;
        }

        .json-boolean {
            color: #fc8181;
        }

        .json-null {
            color: #a0aec0;
        }
        
        .error-table {
            width: 100%;
            margin-top: 1rem;
        }
        
        .error-table th {
            background-color: #2d3748;
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }
        
        .error-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← 返回主頁面</a>
        
        <div class="header">
            <h1>IB API 數據測試頁面</h1>
            <p>顯示所有可從 Interactive Brokers API 獲取的數據</p>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button id="updateBtn" onclick="updateData()">更新數據</button>
                <button onclick="loadData()">重新載入</button>
                <button onclick="clearDisplay()">清除顯示</button>
                <div class="status">
                    <div class="status-indicator disconnected" id="statusIndicator"></div>
                    <span id="statusText">未連接</span>
                </div>
            </div>
            <div id="message"></div>
        </div>

        <div class="section-tabs">
            <button class="tab active" onclick="showTab('summary')">摘要</button>
            <button class="tab" onclick="showTab('positions')">持倉明細</button>
            <button class="tab" onclick="showTab('account')">賬戶信息</button>
            <button class="tab" onclick="showTab('market')">市場數據</button>
            <button class="tab" onclick="showTab('options')">期權數據</button>
            <button class="tab" onclick="showTab('errors')">錯誤日誌</button>
            <button class="tab" onclick="showTab('raw')">原始數據</button>
        </div>
        
        <div id="summaryTab" class="tab-content active">
            <div class="data-section">
                <h2>數據摘要</h2>
                <div id="summaryContent" class="summary-grid">
                    <div class="summary-card">
                        <h3>總持倉數</h3>
                        <div class="value" id="totalPositions">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>期權數量</h3>
                        <div class="value" id="optionsCount">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>股票數量</h3>
                        <div class="value" id="stocksCount">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>總市值</h3>
                        <div class="value" id="totalValue">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>最後更新</h3>
                        <div class="value" id="lastUpdate" style="font-size: 16px;">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>數據來源</h3>
                        <div class="value" id="dataSource" style="font-size: 16px;">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="positionsTab" class="tab-content">
            <div class="data-section">
                <h2>持倉明細</h2>
                <div id="positionsContent" class="data-grid"></div>
            </div>
        </div>
        
        <div id="accountTab" class="tab-content">
            <div class="data-section">
                <h2>賬戶信息</h2>
                <div id="accountContent"></div>
            </div>
        </div>
        
        <div id="marketTab" class="tab-content">
            <div class="data-section">
                <h2>市場數據</h2>
                <div id="marketContent" class="data-grid"></div>
            </div>
        </div>
        
        <div id="optionsTab" class="tab-content">
            <div class="data-section">
                <h2>期權數據（希臘值）</h2>
                <div id="optionsContent" class="data-grid"></div>
            </div>
        </div>
        
        <div id="errorsTab" class="tab-content">
            <div class="data-section">
                <h2>API 錯誤日誌</h2>
                <div id="errorsContent"></div>
            </div>
        </div>
        
        <div id="rawTab" class="tab-content">
            <div class="data-section">
                <h2>原始 JSON 數據</h2>
                <div id="rawContent" class="json-viewer"></div>
            </div>
        </div>

        <!-- 可用的 API 方法 -->
        <div class="data-section">
            <h2>IB API 可用方法（持倉相關）</h2>
            <div class="api-methods">
                <h3>當前使用的方法：</h3>
                <div class="method-item">
                    <strong>reqPositions()</strong> - 請求所有持倉
                    <ul>
                        <li>返回: account, contract, position, avgCost</li>
                    </ul>
                </div>

                <h3>其他可用的持倉相關方法：</h3>
                <div class="method-item">
                    <strong>reqPositionsMulti(reqId, account, modelCode)</strong> - 請求特定賬戶/模型的持倉
                </div>
                <div class="method-item">
                    <strong>reqAccountSummary(reqId, group, tags)</strong> - 請求賬戶摘要
                    <ul>
                        <li>可用標籤: AccountType, NetLiquidation, TotalCashValue, SettledCash, AccruedCash, BuyingPower, EquityWithLoanValue, PreviousEquityWithLoanValue, GrossPositionValue, RegTEquity, RegTMargin, SMA, InitMarginReq, MaintMarginReq, AvailableFunds, ExcessLiquidity, Cushion, FullInitMarginReq, FullMaintMarginReq, FullAvailableFunds, FullExcessLiquidity, LookAheadNextChange, LookAheadInitMarginReq, LookAheadMaintMarginReq, LookAheadAvailableFunds, LookAheadExcessLiquidity, HighestSeverity, DayTradesRemaining, Leverage</li>
                    </ul>
                </div>
                <div class="method-item">
                    <strong>reqAccountUpdates(subscribe, acctCode)</strong> - 訂閱賬戶更新
                    <ul>
                        <li>返回實時的持倉和賬戶價值更新</li>
                    </ul>
                </div>
                <div class="method-item">
                    <strong>reqPnL(reqId, account, modelCode)</strong> - 請求盈虧信息
                </div>
                <div class="method-item">
                    <strong>reqPnLSingle(reqId, account, modelCode, contractId)</strong> - 請求單個持倉的盈虧
                </div>

                <h3>市場數據相關方法（獲取實時價格）：</h3>
                <div class="method-item">
                    <strong>reqMktData(reqId, contract, genericTickList, snapshot, regulatorySnapshot, mktDataOptions)</strong> - 請求實時市場數據
                    <ul>
                        <li>可獲取: 買價、賣價、最新價、成交量、今日最高/最低等</li>
                    </ul>
                </div>
                <div class="method-item">
                    <strong>reqHistoricalData(reqId, contract, endDateTime, durationStr, barSizeSetting, whatToShow, useRTH, formatDate, keepUpToDate, chartOptions)</strong> - 請求歷史數據
                </div>
                <div class="method-item">
                    <strong>reqRealTimeBars(reqId, contract, barSize, whatToShow, useRTH, realTimeBarsOptions)</strong> - 請求實時K線
                </div>

                <h3>期權特定方法：</h3>
                <div class="method-item">
                    <strong>calculateImpliedVolatility(reqId, contract, optionPrice, underPrice, implVolOptions)</strong> - 計算隱含波動率
                </div>
                <div class="method-item">
                    <strong>calculateOptionPrice(reqId, contract, volatility, underPrice, optPrcOptions)</strong> - 計算期權價格
                </div>
                <div class="method-item">
                    <strong>reqSecDefOptParams(reqId, underlyingSymbol, futFopExchange, underlyingSecType, underlyingConId)</strong> - 請求期權鏈參數
                </div>
            </div>
        </div>

        <!-- Contract 對象可用字段 -->
        <div class="data-section">
            <h2>Contract 對象可用字段</h2>
            <div class="api-methods">
                <p>從 position() 回調中的 Contract 對象可以獲取的所有字段：</p>
                <table>
                    <tr>
                        <th>字段名</th>
                        <th>說明</th>
                        <th>示例值</th>
                    </tr>
                    <tr>
                        <td><strong>symbol</strong></td>
                        <td>標的代碼</td>
                        <td>AAPL, NVDA</td>
                    </tr>
                    <tr>
                        <td><strong>secType</strong></td>
                        <td>證券類型</td>
                        <td>STK (股票), OPT (期權), FUT (期貨), CASH (現金)</td>
                    </tr>
                    <tr>
                        <td><strong>lastTradeDateOrContractMonth</strong></td>
                        <td>到期日或合約月份</td>
                        <td>20250919 (期權)</td>
                    </tr>
                    <tr>
                        <td><strong>strike</strong></td>
                        <td>行權價</td>
                        <td>150.0 (期權)</td>
                    </tr>
                    <tr>
                        <td><strong>right</strong></td>
                        <td>期權類型</td>
                        <td>C (Call), P (Put)</td>
                    </tr>
                    <tr>
                        <td><strong>multiplier</strong></td>
                        <td>合約乘數</td>
                        <td>100 (期權)</td>
                    </tr>
                    <tr>
                        <td><strong>exchange</strong></td>
                        <td>交易所</td>
                        <td>SMART, NASDAQ, NYSE</td>
                    </tr>
                    <tr>
                        <td><strong>currency</strong></td>
                        <td>貨幣</td>
                        <td>USD, HKD, EUR</td>
                    </tr>
                    <tr>
                        <td><strong>localSymbol</strong></td>
                        <td>本地代碼</td>
                        <td>AAPL  250919P00150000</td>
                    </tr>
                    <tr>
                        <td><strong>tradingClass</strong></td>
                        <td>交易類別</td>
                        <td>AAPL</td>
                    </tr>
                    <tr>
                        <td><strong>conId</strong></td>
                        <td>合約ID</td>
                        <td>265598 (唯一標識)</td>
                    </tr>
                    <tr>
                        <td><strong>primaryExchange</strong></td>
                        <td>主要交易所</td>
                        <td>NASDAQ</td>
                    </tr>
                    <tr>
                        <td><strong>includeExpired</strong></td>
                        <td>包含已到期</td>
                        <td>true/false</td>
                    </tr>
                    <tr>
                        <td><strong>secIdType</strong></td>
                        <td>證券ID類型</td>
                        <td>ISIN, CUSIP</td>
                    </tr>
                    <tr>
                        <td><strong>secId</strong></td>
                        <td>證券ID</td>
                        <td>US0378331005</td>
                    </tr>
                    <tr>
                        <td><strong>comboLegsDescrip</strong></td>
                        <td>組合腿描述</td>
                        <td>用於組合訂單</td>
                    </tr>
                    <tr>
                        <td><strong>comboLegs</strong></td>
                        <td>組合腿列表</td>
                        <td>組合訂單的各個部分</td>
                    </tr>
                    <tr>
                        <td><strong>deltaNeutralContract</strong></td>
                        <td>Delta中性合約</td>
                        <td>用於對沖</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- 建議增強功能 -->
        <div class="data-section">
            <h2>建議的數據增強</h2>
            <div class="info-card">
                <h3>目前缺少但可以獲取的數據：</h3>
                <ol>
                    <li><strong>實時市場價格</strong> - 使用 reqMktData() 獲取當前市價，計算真實的未實現盈虧</li>
                    <li><strong>賬戶淨值</strong> - 使用 reqAccountSummary() 獲取 NetLiquidation, BuyingPower 等</li>
                    <li><strong>今日盈虧</strong> - 使用 reqPnL() 獲取實時盈虧數據</li>
                    <li><strong>期權希臘值</strong> - 使用 reqMktData() 的 genericTickList="13,14,15,16,17" 獲取 Delta, Gamma, Theta, Vega</li>
                    <li><strong>隱含波動率</strong> - 使用 reqMktData() 的 genericTickList="24" 獲取 IV</li>
                    <li><strong>股息信息</strong> - 使用 reqMktData() 的 genericTickList="59" 獲取股息</li>
                    <li><strong>保證金要求</strong> - 使用 reqAccountSummary() 獲取 InitMarginReq, MaintMarginReq</li>
                    <li><strong>歷史數據</strong> - 使用 reqHistoricalData() 獲取價格走勢圖表</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        function showTab(tabName) {
            // 隱藏所有標籤內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有標籤的活動狀態
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 顯示選中的標籤
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 設置活動標籤
            event.target.classList.add('active');
        }
        
        function updateData() {
            const btn = document.getElementById('updateBtn');
            const messageDiv = document.getElementById('message');
            
            btn.disabled = true;
            btn.innerHTML = '更新中... <div class="loading"></div>';
            messageDiv.innerHTML = '';
            
            fetch('/api/update', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '更新數據';
                    
                    if (data.success) {
                        messageDiv.innerHTML = '<div class="success-message">' + data.message + '</div>';
                        loadData();
                    } else {
                        messageDiv.innerHTML = '<div class="error-message">錯誤: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '更新數據';
                    messageDiv.innerHTML = '<div class="error-message">網絡錯誤: ' + error + '</div>';
                });
        }
        
        function loadData() {
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    currentData = data;
                    displayData(data);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('message').innerHTML = 
                        '<div class="error-message">載入數據失敗: ' + error + '</div>';
                });
        }

        
        function displayData(data) {
            // 更新摘要
            updateSummary(data);
            
            // 更新持倉
            updatePositions(data.positions || []);
            
            // 更新賬戶信息
            updateAccount(data);
            
            // 更新市場數據
            updateMarketData(data.positions || []);
            
            // 更新期權數據
            updateOptionsData(data.positions || []);
            
            // 更新錯誤日誌
            updateErrorsData(data);
            
            // 更新原始數據
            updateRawData(data);
            
            // 更新狀態
            checkStatus();
        }
        
        function updateSummary(data) {
            const summary = data.summary || {};
            document.getElementById('totalPositions').textContent = summary.total_positions || 0;
            document.getElementById('optionsCount').textContent = summary.options_count || 0;
            document.getElementById('stocksCount').textContent = summary.stocks_count || 0;
            document.getElementById('totalValue').textContent = formatMoney(summary.total_market_value || 0);
            document.getElementById('lastUpdate').textContent = data.last_update || '-';
            document.getElementById('dataSource').textContent = data.source || '-';
        }
        
        function updatePositions(positions) {
            const container = document.getElementById('positionsContent');
            
            if (positions.length === 0) {
                container.innerHTML = '<p>無持倉數據</p>';
                return;
            }
            
            container.innerHTML = positions.map(pos => `
                <div class="position-card">
                    <div class="position-header">
                        <span class="position-symbol">${pos.symbol}</span>
                        <span class="position-type">${pos.secType}</span>
                    </div>
                    <table class="data-table">
                        <tr>
                            <td>數量</td>
                            <td>${pos.position}</td>
                        </tr>
                        <tr>
                            <td>平均成本</td>
                            <td>${formatMoney(pos.avgCost)}</td>
                        </tr>
                        <tr>
                            <td>市值</td>
                            <td>${formatMoney(pos.market_value || 0)}</td>
                        </tr>
                        ${pos.secType === 'OPT' ? `
                            <tr>
                                <td>行使價</td>
                                <td>${pos.strike}</td>
                            </tr>
                            <tr>
                                <td>權利</td>
                                <td>${pos.right === 'C' ? 'Call' : 'Put'}</td>
                            </tr>
                            <tr>
                                <td>到期日</td>
                                <td>${pos.expiry_formatted || pos.expiry}</td>
                            </tr>
                            <tr>
                                <td>距到期天數</td>
                                <td>${pos.days_to_expiry || '-'}</td>
                            </tr>
                        ` : ''}
                        <tr>
                            <td>交易所</td>
                            <td>${pos.exchange}</td>
                        </tr>
                        <tr>
                            <td>貨幣</td>
                            <td>${pos.currency}</td>
                        </tr>
                        ${pos.unrealizedPNL ? `
                            <tr>
                                <td>未實現盈虧</td>
                                <td style="color: ${pos.unrealizedPNL >= 0 ? 'green' : 'red'}">
                                    ${formatMoney(pos.unrealizedPNL)}
                                </td>
                            </tr>
                        ` : ''}
                    </table>
                </div>
            `).join('');
        }
        
        function updateAccount(data) {
            const container = document.getElementById('accountContent');
            const accountSummary = data.account_summary || {};
            const accountValues = data.account_values || {};
            const accountPnl = data.account_pnl || {};
            
            let html = '<h3>賬戶摘要</h3><table class="data-table">';
            
            // 賬戶摘要
            for (const [key, value] of Object.entries(accountSummary)) {
                html += `<tr>
                    <td>${formatAccountKey(key)}</td>
                    <td>${value.value} ${value.currency || ''}</td>
                </tr>`;
            }
            
            // 賬戶PnL
            if (accountPnl.dailyPnL !== undefined) {
                html += `<tr>
                    <td>每日盈虧</td>
                    <td style="color: ${accountPnl.dailyPnL >= 0 ? 'green' : 'red'}">
                        ${formatMoney(accountPnl.dailyPnL)}
                    </td>
                </tr>`;
            }
            
            if (accountPnl.unrealizedPnL !== undefined) {
                html += `<tr>
                    <td>未實現盈虧</td>
                    <td style="color: ${accountPnl.unrealizedPnL >= 0 ? 'green' : 'red'}">
                        ${formatMoney(accountPnl.unrealizedPnL)}
                    </td>
                </tr>`;
            }
            
            if (accountPnl.realizedPnL !== undefined) {
                html += `<tr>
                    <td>已實現盈虧</td>
                    <td style="color: ${accountPnl.realizedPnL >= 0 ? 'green' : 'red'}">
                        ${formatMoney(accountPnl.realizedPnL)}
                    </td>
                </tr>`;
            }
            
            html += '</table>';
            
            // 賬戶價值
            if (Object.keys(accountValues).length > 0) {
                html += '<h3 style="margin-top: 20px;">賬戶價值明細</h3><table class="data-table">';
                for (const [key, value] of Object.entries(accountValues)) {
                    html += `<tr>
                        <td>${formatAccountKey(key)}</td>
                        <td>${value.value} ${value.currency || ''}</td>
                    </tr>`;
                }
                html += '</table>';
            }
            
            container.innerHTML = html || '<p>無賬戶數據</p>';
        }
        
        function updateMarketData(positions) {
            const container = document.getElementById('marketContent');
            
            const positionsWithMarket = positions.filter(pos => pos.market_data);
            
            if (positionsWithMarket.length === 0) {
                container.innerHTML = '<p>無市場數據</p>';
                return;
            }
            
            container.innerHTML = positionsWithMarket.map(pos => `
                <div class="position-card">
                    <div class="position-header">
                        <span class="position-symbol">${pos.symbol}</span>
                        <span class="position-type">${pos.secType}</span>
                    </div>
                    <table class="data-table">
                        ${Object.entries(pos.market_data).map(([key, value]) => `
                            <tr>
                                <td>${formatMarketKey(key)}</td>
                                <td>${formatMarketValue(key, value)}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `).join('');
        }
        
        function updateOptionsData(positions) {
            const container = document.getElementById('optionsContent');
            
            const optionsWithGreeks = positions.filter(pos => 
                pos.secType === 'OPT' && pos.options_data
            );
            
            if (optionsWithGreeks.length === 0) {
                container.innerHTML = '<p>無期權希臘值數據</p>';
                return;
            }
            
            container.innerHTML = optionsWithGreeks.map(pos => {
                const greeks = pos.options_data.modelGreeks || 
                              pos.options_data.lastGreeks || 
                              pos.options_data.bidGreeks || 
                              pos.options_data.askGreeks || {};
                
                return `
                    <div class="position-card">
                        <div class="position-header">
                            <span class="position-symbol">${pos.symbol}</span>
                            <span class="position-type">
                                ${pos.strike} ${pos.right === 'C' ? 'Call' : 'Put'}
                            </span>
                        </div>
                        <div class="greeks-table">
                            <div class="greek-item">
                                <div class="label">Delta</div>
                                <div class="value">${formatNumber(greeks.delta)}</div>
                            </div>
                            <div class="greek-item">
                                <div class="label">Gamma</div>
                                <div class="value">${formatNumber(greeks.gamma)}</div>
                            </div>
                            <div class="greek-item">
                                <div class="label">Theta</div>
                                <div class="value">${formatNumber(greeks.theta)}</div>
                            </div>
                            <div class="greek-item">
                                <div class="label">Vega</div>
                                <div class="value">${formatNumber(greeks.vega)}</div>
                            </div>
                            <div class="greek-item">
                                <div class="label">IV</div>
                                <div class="value">${formatPercent(greeks.impliedVolatility)}</div>
                            </div>
                            <div class="greek-item">
                                <div class="label">標的價格</div>
                                <div class="value">${formatMoney(greeks.underlyingPrice)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRawData(data) {
            const container = document.getElementById('rawContent');
            container.textContent = JSON.stringify(data, null, 2);
        }
        
        function updateErrorsData(data) {
            const errors = data.errors || [];
            const container = document.getElementById('errorsContent');
            
            if (errors.length === 0) {
                container.innerHTML = '<p style="color: #68d391;">✓ 沒有錯誤</p>';
                return;
            }
            
            // 按錯誤碼分組
            const errorGroups = {};
            errors.forEach(error => {
                const code = error.errorCode;
                if (!errorGroups[code]) {
                    errorGroups[code] = {
                        code: code,
                        message: error.errorString,
                        count: 0,
                        examples: []
                    };
                }
                errorGroups[code].count++;
                if (errorGroups[code].examples.length < 3) {
                    errorGroups[code].examples.push(error);
                }
            });
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <p>總錯誤數: ${errors.length}</p>
                    <p style="font-size: 0.875rem; color: #a0aec0;">顯示最近 20 個錯誤</p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">錯誤碼</th>
                            <th style="text-align: left;">錯誤說明</th>
                            <th style="text-align: center;">次數</th>
                            <th style="text-align: left;">相關標的</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.values(errorGroups).sort((a, b) => b.count - a.count).forEach(group => {
                const symbols = [...new Set(group.examples.map(e => e.symbol).filter(s => s !== 'Unknown' && s !== 'System'))];
                const symbolsText = symbols.length > 0 ? symbols.join(', ') : 'System';
                const rowClass = group.examples[0].level === 'error' ? 'style="background-color: rgba(252, 129, 129, 0.1);"' : '';
                
                html += `
                    <tr ${rowClass}>
                        <td>${group.code}</td>
                        <td>${getErrorDescription(group.code, group.message)}</td>
                        <td style="text-align: center;">${group.count}</td>
                        <td>${symbolsText}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function getErrorDescription(code, message) {
            const descriptions = {
                321: '請求參數錯誤（通常是 tick list 或 exchange 設置問題）',
                162: '期權沒有歷史日線數據（這是正常的）',
                200: '找不到證券定義（可能是交易所設置錯誤）',
                102: '重複的請求 ID',
                2103: '市場數據連接中斷',
                2105: '歷史數據連接中斷'
            };
            
            if (descriptions[code]) {
                return `${descriptions[code]}<br><small style="color: #a0aec0;">${message}</small>`;
            }
            return message;
        }
        
        function clearDisplay() {
            document.getElementById('summaryContent').innerHTML = 
                '<div class="summary-card"><h3>數據已清除</h3></div>';
            document.getElementById('positionsContent').innerHTML = '';
            document.getElementById('accountContent').innerHTML = '';
            document.getElementById('marketContent').innerHTML = '';
            document.getElementById('optionsContent').innerHTML = '';
            document.getElementById('errorsContent').innerHTML = '';
            document.getElementById('rawContent').textContent = '';
            document.getElementById('message').innerHTML = '';
        }
        
        function checkStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const indicator = document.getElementById('statusIndicator');
                    const text = document.getElementById('statusText');
                    
                    if (data.tws_connected) {
                        indicator.classList.remove('disconnected');
                        indicator.classList.add('connected');
                        text.textContent = '已連接';
                    } else {
                        indicator.classList.remove('connected');
                        indicator.classList.add('disconnected');
                        text.textContent = '未連接';
                    }
                });
        }
        
        // 格式化函數
        function formatMoney(value) {
            if (value === undefined || value === null) return '-';
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }
        
        function formatNumber(value, decimals = 4) {
            if (value === undefined || value === null) return '-';
            return parseFloat(value).toFixed(decimals);
        }
        
        function formatPercent(value) {
            if (value === undefined || value === null) return '-';
            return (parseFloat(value) * 100).toFixed(2) + '%';
        }
        
        function formatAccountKey(key) {
            const keyMap = {
                'NetLiquidation': '淨清算價值',
                'TotalCashValue': '總現金價值',
                'SettledCash': '已結算現金',
                'AccruedCash': '應計現金',
                'BuyingPower': '購買力',
                'EquityWithLoanValue': '含貸款股權',
                'PreviousEquityWithLoanValue': '前日含貸款股權',
                'GrossPositionValue': '總持倉價值',
                'InitMarginReq': '初始保證金要求',
                'MaintMarginReq': '維持保證金要求',
                'AvailableFunds': '可用資金',
                'ExcessLiquidity': '超額流動性',
                'Cushion': '緩衝',
                'DayTradesRemaining': '剩餘日內交易次數',
                'Leverage': '槓桿',
                'Currency': '貨幣'
            };
            return keyMap[key] || key;
        }
        
        function formatMarketKey(key) {
            const keyMap = {
                'bid': '買價',
                'ask': '賣價',
                'last': '最新價',
                'high': '最高價',
                'low': '最低價',
                'close': '收盤價',
                'open': '開盤價',
                'markPrice': '標記價格',
                'bidSize': '買量',
                'askSize': '賣量',
                'lastSize': '最新成交量',
                'volume': '成交量',
                'avgVolume': '平均成交量',
                'histVolatility': '歷史波動率',
                'impliedVolatility': '隱含波動率',
                'callOpenInterest': 'Call未平倉量',
                'putOpenInterest': 'Put未平倉量',
                'shortableShares': '可做空股數'
            };
            return keyMap[key] || key;
        }
        
        function formatMarketValue(key, value) {
            if (value === undefined || value === null) return '-';
            
            if (['bid', 'ask', 'last', 'high', 'low', 'close', 'open', 'markPrice'].includes(key)) {
                return formatMoney(value);
            } else if (['histVolatility', 'impliedVolatility'].includes(key)) {
                return formatPercent(value);
            } else {
                return value.toLocaleString();
            }
        }
        
        // 頁面載入時自動載入數據
        window.onload = function() {
            loadData();
            checkStatus();
            
            // 每30秒檢查一次狀態
            setInterval(checkStatus, 30000);
        };
    </script>
</body>
</html>