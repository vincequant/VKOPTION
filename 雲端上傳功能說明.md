# 雲端上傳功能說明 - 完整計算邏輯版本

## 更新日期：2025-06-23

## 功能概述

新版雲端上傳功能現已實現**100%本地計算邏輯同步**，確保雲端能夠完整重現本地儀表板的所有計算結果。

## 主要特性

### 1. 完整數據上傳
- ✅ 原始持倉數據（從 TWS API 獲取）
- ✅ 所有本地計算結果
- ✅ 計算公式文檔
- ✅ 常量定義（如匯率）

### 2. 計算邏輯包含

#### 期權計算
- **距離幅度**：`((標的價格 - 行權價) / 行權價) × 100`
- **Short Put 實際到期價值**：
  - 不被行權時：`平均成本 × 手數 × 100`
  - 被行權時：`-((行權價 - 標的價格 - 平均成本) × 手數 × 100)`
- **接貨資金**：`(行權價 - 平均成本) × 手數 × 100`

#### 股票計算
- **盈虧金額**：`(持倉數量 × 現價) - (持倉數量 × 平均成本)`
- **盈虧百分比**：`(盈虧金額 / 成本) × 100`

#### 回報率計算
- **最大回報率**：`(實際到期價值 / 最大資金需求) × 100`
- **當前回報率**：`(實際到期價值 / 淨清算價值) × 100`

### 3. 上傳數據結構

```json
{
  "portfolio_data": {原始數據},
  "calculated_data": {
    "us_options": {
      "total_expiry_value": 215645.00,
      "actual_expiry_value": 284240.30,
      "max_capital_required": 5784269.70,
      "total_pnl": 68526.49,
      "positions": [詳細計算結果]
    },
    "hk_options": {...},
    "stocks": {...},
    "summary": {...},
    "expiry_groups": [...]
  },
  "version": "2.0",
  "calculation_formulas": {所有公式},
  "constants": {"USD_TO_HKD": 7.8}
}
```

## 使用方法

1. 在儀表板頁面點擊「上傳雲端」按鈕
2. 系統會自動：
   - 收集所有原始數據
   - 執行本地計算邏輯
   - 打包計算結果和公式
   - 上傳到雲端 API

3. 成功後會顯示：「✅ 成功上傳 XX 個持倉及完整計算邏輯」

## 雲端處理

雲端接收到數據後可以：
1. 直接使用已計算的結果展示
2. 根據提供的公式重新計算驗證
3. 對數據進行進一步分析

## 技術實現

### 後端 (app.py)
- 新增 `calculate_cloud_data()` 函數：執行所有計算邏輯
- 更新 `upload_to_cloud()` 函數：包含計算結果和公式

### 前端 (dashboard_new.html)
- 新增 `collectAllCalculations()` 函數：收集所有本地計算
- 更新 `uploadToCloud()` 函數：發送完整數據

## 驗證測試

運行測試腳本驗證計算邏輯：
```bash
./ib_env/bin/python test_cloud_upload.py
```

## 注意事項

1. 確保雲端 API 能夠處理新版本格式（version: "2.0"）
2. 上傳數據量較大，建議使用壓縮傳輸
3. 敏感數據（如 API 密鑰）不會被上傳

## 優勢

1. **數據完整性**：雲端獲得與本地完全一致的數據
2. **計算透明**：所有公式都有文檔說明
3. **靈活處理**：雲端可選擇使用預計算結果或重新計算
4. **版本控制**：通過版本號管理不同的數據格式

## 未來優化

1. 添加數據壓縮以減少傳輸量
2. 實現增量更新而非全量上傳
3. 添加數據校驗和以確保完整性
4. 支持歷史數據對比分析