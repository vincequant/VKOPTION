<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Portfolio Monitor - å€‰ä½ç›£æ§</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #212529;
            line-height: 1.5;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: #212529;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-link {
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .nav-link:hover {
            background-color: #5c636a;
        }

        .update-button {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .update-button:hover {
            background-color: #0b5ed7;
        }

        .update-button:active {
            background-color: #0a58ca;
        }

        .update-button.loading {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .update-button.loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #198754;
        }

        .status-dot.disconnected {
            background-color: #dc3545;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* å„€è¡¨æ¿å€å¡Š */
        .dashboard-section {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .dashboard-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* è³¬æˆ¶è³‡è¨Šå€ */
        .account-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .account-info .section-header {
            color: white;
            border-bottom-color: rgba(255, 255, 255, 0.2);
        }

        .account-info .main-metric-label {
            color: rgba(255, 255, 255, 0.8);
        }

        .account-info .main-metric-value {
            color: white;
        }

        .account-info .hkd-value {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ä¸»è¦æ‘˜è¦å€ */
        .main-summary {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
        }

        .main-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .main-metric {
            text-align: center;
        }

        .main-metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .main-metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.25rem;
        }

        .main-metric-value.negative {
            color: #dc3545;
        }

        .main-metric-value.positive {
            color: #198754;
        }

        .main-metric-sub {
            font-size: 1rem;
            color: #6c757d;
        }

        .hkd-value {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: normal;
        }

        /* åˆ°æœŸæ—¥åˆ†çµ„æ‘˜è¦ */
        .expiry-summary {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .expiry-summary-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #212529;
        }

        .expiry-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .expiry-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s;
        }

        .expiry-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .expiry-date {
            font-size: 0.875rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .days-left {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .days-left.urgent {
            color: #dc3545;
            font-weight: 600;
        }

        .expiry-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .expiry-value.positive {
            color: #198754;
        }

        .expiry-value-hkd {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .expiry-count {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .expiry-pnl {
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .expiry-pnl.positive {
            color: #198754;
        }

        .expiry-pnl.negative {
            color: #dc3545;
        }

        /* æŒå€‰çµ±è¨ˆ */
        .position-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* è¨‚é–±ç‹€æ…‹æç¤º */
        .subscription-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .subscription-warning-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 0.5rem;
        }
        
        .subscription-warning-text {
            color: #856404;
            font-size: 0.875rem;
        }
        
        .data-status-icon {
            display: inline-block;
            margin-left: 0.25rem;
            cursor: help;
        }
        
        .data-status-icon.missing {
            color: #dc3545;
        }
        
        .data-status-icon.available {
            color: #198754;
        }
        
        /* æœŸæ¬Šé¡å‹å¾½ç«  */
        .option-type-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .option-type-badge.call {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .option-type-badge.call:hover {
            background-color: #c3e6cb;
            transform: scale(1.1);
        }
        
        .option-type-badge.put {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .option-type-badge.put:hover {
            background-color: #f5c6cb;
            transform: scale(1.1);
        }
        
        .option-type-badge.stock {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .option-type-badge.stock:hover {
            background-color: #bee5eb;
            transform: scale(1.1);
        }

        /* æ’åºæ¨£å¼ */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .sortable:hover {
            background-color: #f0f0f0;
        }
        
        .sortable i {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: 0.25rem;
        }
        
        .sortable.sorted-asc i:before {
            content: "\f0de"; /* fa-sort-up */
            color: #0d6efd;
        }
        
        .sortable.sorted-desc i:before {
            content: "\f0dd"; /* fa-sort-down */
            color: #0d6efd;
        }
        
        /* åˆ°æœŸæ—¥åˆ†çµ„åˆ‡æ› */
        .group-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        /* æŒå€‰åˆ†é¡æ¨™ç±¤ */
        .position-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
            padding-bottom: 0;
        }
        
        .position-tab {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .position-tab:hover {
            color: #495057;
        }
        
        .position-tab.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
        }
        
        .position-section {
            display: block;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #0d6efd;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* æŒå€‰è¡¨æ ¼ */
        .table-card {
            background-color: #ffffff;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #212529;
        }

        .filter-tabs {
            display: flex;
            gap: 0.25rem;
        }

        .filter-tab {
            padding: 0.375rem 0.75rem;
            border: 1px solid #dee2e6;
            background-color: #ffffff;
            color: #6c757d;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.25rem;
        }

        .filter-tab:hover {
            background-color: #f8f9fa;
        }

        .filter-tab.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 500;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #6c757d;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .symbol-cell {
            font-weight: 500;
            color: #212529;
        }

        .option-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .badge-call {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .badge-put {
            background-color: #f8d7da;
            color: #721c24;
        }

        .text-right {
            text-align: right;
        }
        
        .expiry-separator {
            background-color: #e9ecef;
            font-weight: 600;
            font-size: 0.875rem;
            color: #495057;
        }
        
        .expiry-separator td {
            padding: 0.5rem 1rem;
            border: none;
        }

        .negative {
            color: #dc3545;
        }

        .positive {
            color: #198754;
        }

        /* é€šçŸ¥æç¤º */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #198754;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.info {
            border-left: 4px solid #0dcaf0;
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                IB Portfolio Monitor
            </div>
            <div class="nav-actions">
                <a href="/dashboard" class="nav-link" style="background-color: #10b981;">
                    <i class="fas fa-chart-pie"></i>
                    å®Œæ•´å„€è¡¨æ¿
                </a>
                <a href="/dashboard_enhanced.html" class="nav-link" style="background-color: #3b82f6;">
                    <i class="fas fa-th"></i>
                    å¢å¼·ç‰ˆæœ¬
                </a>
                <button class="update-button" id="updateBtn" onclick="updateData()">
                    <i class="fas fa-sync-alt"></i>
                    æ›´æ–°æŒå€‰
                </button>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">æª¢æŸ¥ä¸­...</span>
                    <span id="updateTime"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- è³¬æˆ¶è³‡è¨Š -->
        <div class="dashboard-section account-info">
            <div class="section-header">
                <i class="fas fa-wallet"></i>
                è³¬æˆ¶è³‡è¨Š
            </div>
            <div class="main-summary-grid">
                <div class="main-metric">
                    <div class="main-metric-label">æ·¨æ¸…ç®—åƒ¹å€¼</div>
                    <div class="main-metric-value" id="netLiquidation">--</div>
                    <div class="main-metric-sub">
                        <span class="hkd-value" id="netLiquidationHKD">--</span>
                    </div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-label">å¯ç”¨è³‡é‡‘</div>
                    <div class="main-metric-value" id="availableFunds">--</div>
                    <div class="main-metric-sub">
                        <span class="hkd-value" id="availableFundsHKD">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒå€‰æ‘˜è¦ -->
        <div class="dashboard-section main-summary">
            <div class="section-header">
                <i class="fas fa-chart-line"></i>
                æŒå€‰æ‘˜è¦
            </div>
            <div class="main-summary-grid">
                <div class="main-metric">
                    <div class="main-metric-label">ç¾è‚¡æœŸæ¬Šåˆ°æœŸåƒ¹å€¼</div>
                    <div class="main-metric-value positive" id="optionsValue">--</div>
                    <div class="main-metric-sub">
                        <span class="hkd-value" id="optionsValueHKD">--</span>
                    </div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-label">è‚¡ç¥¨å¸‚å€¼</div>
                    <div class="main-metric-value" id="stocksValue">--</div>
                    <div class="main-metric-sub">
                        <span class="hkd-value" id="stocksValueHKD">--</span>
                    </div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-label">ç¸½ç›ˆè™§</div>
                    <div class="main-metric-value" id="totalPnL">--</div>
                    <div class="main-metric-sub">
                        <span class="hkd-value" id="totalPnLHKD">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ°æœŸæ—¥åˆ†çµ„æ‘˜è¦ -->
        <div class="dashboard-section expiry-summary" id="expirySummary" style="display: none;">
            <div class="section-header">
                <i class="fas fa-calendar-alt"></i>
                æœŸæ¬Šåˆ°æœŸåˆ†å¸ƒ
            </div>
            <div class="expiry-cards" id="expiryCards">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æŒå€‰çµ±è¨ˆ -->
        <div class="position-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalPositions">--</div>
                <div class="stat-label">æŒå€‰ç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="optionsCount">--</div>
                <div class="stat-label">æœŸæ¬Šæ•¸é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stocksCount">--</div>
                <div class="stat-label">è‚¡ç¥¨æ•¸é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastUpdate">--</div>
                <div class="stat-label">æœ€å¾Œæ›´æ–°</div>
            </div>
        </div>

        <!-- æŒå€‰è¡¨æ ¼ -->
        <div class="table-card">
            <!-- æŒå€‰åˆ†é¡æ¨™ç±¤ -->
            <div class="position-tabs">
                <button class="position-tab active" onclick="switchPositionTab('us')">ç¾è‚¡æœŸæ¬Š</button>
                <button class="position-tab" onclick="switchPositionTab('hk')">æ¸¯è‚¡æœŸæ¬Š</button>
                <button class="position-tab" onclick="switchPositionTab('stock')">è‚¡ç¥¨æŒå€‰</button>
            </div>
            <!-- ç¾è‚¡æœŸæ¬ŠæŒå€‰ -->
            <div class="position-section" id="usOptionsSection">
            <div class="table-header">
                <h2 class="table-title">ç¾è‚¡æœŸæ¬ŠæŒå€‰</h2>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterPositions('all', 'us')">å…¨éƒ¨</button>
                        <button class="filter-tab" onclick="filterPositions('expired', 'us')">å·²åˆ°æœŸ</button>
                        <button class="filter-tab" onclick="filterPositions('30days', 'us')">30å¤©å…§</button>
                        <button class="filter-tab" onclick="filterPositions('90days', 'us')">90å¤©å…§</button>
                    </div>
                    <div class="group-toggle">
                        <label for="groupByExpiryUS" style="font-size: 0.875rem; color: #495057;">åˆ°æœŸæ—¥åˆ†çµ„</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="groupByExpiryUS" checked onchange="toggleGrouping('us')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="update-button" onclick="updateUnderlyingPrices()" id="updatePricesBtn">
                        <i class="fas fa-sync-alt"></i> æ›´æ–°åƒ¹æ ¼
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('symbol', 'us')">æ¨™çš„ <i class="fas fa-sort"></i></th>
                            <th>é¡å‹</th>
                            <th class="text-right sortable" onclick="sortTable('strike', 'us')">è¡Œæ¬Šåƒ¹ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('underlyingPrice', 'us')">æ¨™çš„ç¾åƒ¹ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('underlyingChange', 'us')">æ¼²è·Œå¹… <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('position', 'us')">æ•¸é‡ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('avgCost', 'us')">å¹³å‡æˆæœ¬ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('currentPrice', 'us')">ç¾åƒ¹ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('marketValue', 'us')">åˆ°æœŸåƒ¹å€¼ <i class="fas fa-sort"></i></th>
                            <th class="text-right">åˆ°æœŸåƒ¹å€¼ (HKD)</th>
                            <th class="sortable" onclick="sortTable('daysToExpiry', 'us')">åˆ°æœŸæ—¥ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('pnl', 'us')">ç›ˆè™§ <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="usOptionsTable">
                        <tr>
                            <td colspan="12" style="text-align: center; color: #6c757d;">
                                æ­£åœ¨è¼‰å…¥æ•¸æ“š...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
            
            <!-- æ¸¯è‚¡æœŸæ¬ŠæŒå€‰ -->
            <div class="position-section" id="hkOptionsSection" style="display: none;">
            <div class="table-header">
                <h2 class="table-title">æ¸¯è‚¡æœŸæ¬ŠæŒå€‰</h2>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterPositions('all', 'hk')">å…¨éƒ¨</button>
                        <button class="filter-tab" onclick="filterPositions('expired', 'hk')">å·²åˆ°æœŸ</button>
                        <button class="filter-tab" onclick="filterPositions('30days', 'hk')">30å¤©å…§</button>
                        <button class="filter-tab" onclick="filterPositions('90days', 'hk')">90å¤©å…§</button>
                    </div>
                    <div class="group-toggle">
                        <label for="groupByExpiryHK" style="font-size: 0.875rem; color: #495057;">åˆ°æœŸæ—¥åˆ†çµ„</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="groupByExpiryHK" checked onchange="toggleGrouping('hk')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('symbol', 'hk')">æ¨™çš„ <i class="fas fa-sort"></i></th>
                            <th>é¡å‹</th>
                            <th class="text-right sortable" onclick="sortTable('strike', 'hk')">è¡Œæ¬Šåƒ¹ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('position', 'hk')">æ•¸é‡ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('avgCost', 'hk')">å¹³å‡æˆæœ¬ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('marketValue', 'hk')">åˆ°æœŸåƒ¹å€¼ (HKD) <i class="fas fa-sort"></i></th>
                            <th class="text-right">åˆ°æœŸåƒ¹å€¼ (USD)</th>
                            <th class="sortable" onclick="sortTable('daysToExpiry', 'hk')">åˆ°æœŸæ—¥ <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="hkOptionsTable">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #6c757d;">
                                æ­£åœ¨è¼‰å…¥æ•¸æ“š...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
            
            <!-- è‚¡ç¥¨æŒå€‰ -->
            <div class="position-section" id="stocksSection" style="display: none;">
            <div class="table-header">
                <h2 class="table-title">è‚¡ç¥¨æŒå€‰</h2>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('symbol', 'stock')">æ¨™çš„ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('currentPrice', 'stock')">ç¾åƒ¹ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('underlyingChange', 'stock')">æ¼²è·Œå¹… <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('position', 'stock')">æ•¸é‡ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('avgCost', 'stock')">å¹³å‡æˆæœ¬ <i class="fas fa-sort"></i></th>
                            <th class="text-right sortable" onclick="sortTable('marketValue', 'stock')">å¸‚å€¼ <i class="fas fa-sort"></i></th>
                            <th class="text-right">å¸‚å€¼ (HKD)</th>
                            <th class="text-right sortable" onclick="sortTable('pnl', 'stock')">ç›ˆè™§ <i class="fas fa-sort"></i></th>
                            <th class="text-right">ç›ˆè™§ %</th>
                        </tr>
                    </thead>
                    <tbody id="stocksTable">
                        <tr>
                            <td colspan="9" style="text-align: center; color: #6c757d;">
                                æ­£åœ¨è¼‰å…¥æ•¸æ“š...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æç¤º -->
    <div class="notification" id="notification"></div>

    <script>
        // å…¨å±€è®Šé‡
        let portfolioData = null;
        let currentFilter = { us: 'all', hk: 'all', stock: 'all' };
        const USD_TO_HKD = 7.8; // ç¾å…ƒå…Œæ¸¯å¹£åŒ¯ç‡
        let underlyingPrices = {}; // åº•å±¤è‚¡ç¥¨åƒ¹æ ¼
        let isUpdatingPrices = false; // é˜²æ­¢é‡è¤‡æ›´æ–°
        let groupByExpiry = { us: true, hk: true }; // æ˜¯å¦æŒ‰åˆ°æœŸæ—¥åˆ†çµ„
        let currentSort = { us: { column: null, direction: 'asc' }, hk: { column: null, direction: 'asc' }, stock: { column: null, direction: 'asc' } }; // ç•¶å‰æ’åºç‹€æ…‹

        // åˆ‡æ›æŒå€‰æ¨™ç±¤
        function switchPositionTab(tab) {
            // æ›´æ–°æ¨™ç±¤æ¨£å¼
            document.querySelectorAll('.position-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é¡¯ç¤º/éš±è—å°æ‡‰çš„å…§å®¹
            document.getElementById('usOptionsSection').style.display = tab === 'us' ? 'block' : 'none';
            document.getElementById('hkOptionsSection').style.display = tab === 'hk' ? 'block' : 'none';
            document.getElementById('stocksSection').style.display = tab === 'stock' ? 'block' : 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            checkStatus();
            setInterval(checkStatus, 5000);
        });

        // åŠ è¼‰æ•¸æ“š
        async function loadData() {
            try {
                const response = await fetch('/api/portfolio');
                portfolioData = await response.json();
                
                if (portfolioData.error && portfolioData.error !== 'No data available') {
                    showNotification('æ•¸æ“šåŠ è¼‰å¤±æ•—: ' + portfolioData.error, 'error');
                } else {
                    updateUI();
                }
            } catch (error) {
                showNotification('ç¶²çµ¡éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æ•¸æ“š
        async function updateData() {
            const btn = document.getElementById('updateBtn');
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> æ›´æ–°ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => loadData(), 1000);
                } else {
                    showNotification(result.message || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> æ›´æ–°æŒå€‰';
                btn.disabled = false;
            }
        }

        // æª¢æŸ¥ç‹€æ…‹
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (status.tws_connected) {
                    statusDot.classList.remove('disconnected');
                    statusText.textContent = 'TWS å·²é€£æ¥';
                } else {
                    statusDot.classList.add('disconnected');
                    statusText.textContent = 'TWS æœªé€£æ¥';
                }
            } catch (error) {
                console.error('ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', error);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            if (!portfolioData) return;

            updateMainSummary();
            updateExpirySummary();
            updatePositionStats();
            updateAllPositionsTables();
            updateTime();
            updateAccountInfo();
            
            // è‡ªå‹•ç²å–è‚¡ç¥¨åƒ¹æ ¼ï¼ˆåŒ…æ‹¬ VXXï¼‰
            fetchUnderlyingPrices();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¨‚é–±éŒ¯èª¤
            if (portfolioData.subscription_errors && Object.keys(portfolioData.subscription_errors).length > 0) {
                const errorCount = Object.keys(portfolioData.subscription_errors).length;
                document.getElementById('subscriptionWarningText').textContent = 
                    `æœ‰ ${errorCount} å€‹æŒå€‰éœ€è¦ä»˜è²»è¨‚é–±æ‰èƒ½ç²å–å®Œæ•´å¸‚å ´æ•¸æ“š`;
                document.getElementById('subscriptionWarning').style.display = 'block';
            }
            
            // å¦‚æœæ•¸æ“šä¸­å·²æœ‰åº•å±¤è‚¡ç¥¨åƒ¹æ ¼ï¼Œç›´æ¥ä½¿ç”¨
            if (portfolioData.underlying_prices) {
                underlyingPrices = portfolioData.underlying_prices;
                displayUnderlyingPrices();
            } else {
                // å¦å‰‡å¾ API ç²å–
                fetchUnderlyingPrices();
            }
        }

        // æ›´æ–°ä¸»è¦æ‘˜è¦
        function updateMainSummary() {
            if (!portfolioData.positions) return;

            // åªè¨ˆç®—ç¾è‚¡æœŸæ¬Šåƒ¹å€¼
            const optionsValue = Math.abs(portfolioData.positions
                .filter(p => p.secType === 'OPT' && p.currency === 'USD')
                .reduce((sum, p) => sum + (p.market_value || 0), 0));
            
            // è¨ˆç®—è‚¡ç¥¨ç¸½åƒ¹å€¼
            const stocksValue = portfolioData.positions
                .filter(p => p.secType === 'STK')
                .reduce((sum, p) => {
                    const priceData = underlyingPrices[p.symbol];
                    if (priceData && priceData.price && p.position) {
                        return sum + (p.position * priceData.price);
                    }
                    return sum + (p.market_value || 0);
                }, 0);
            
            // åªè¨ˆç®—ç¾è‚¡æœŸæ¬Šç›ˆè™§
            const optionsPnL = portfolioData.positions
                .filter(p => p.secType === 'OPT' && p.currency === 'USD')
                .reduce((sum, p) => {
                    if (p.pnl !== null && p.pnl !== undefined) {
                        return sum + p.pnl;
                    }
                    return sum;
                }, 0);
            
            // æš«æ™‚ä¸è¨ˆç®—è‚¡ç¥¨ç›ˆè™§ï¼Œå› ç‚ºVXXç„¡åƒ¹æ ¼æ•¸æ“š
            const totalPnL = optionsPnL;

            // æ›´æ–°é¡¯ç¤ºï¼ˆç¾è‚¡æœŸæ¬Šï¼‰
            document.getElementById('optionsValue').textContent = '$' + formatNumber(optionsValue, 0);
            document.getElementById('optionsValueHKD').textContent = `(HKD ${formatNumber(optionsValue * USD_TO_HKD, 0)})`;
            
            // ä¿®æ­£è‚¡ç¥¨å¸‚å€¼é¡¯ç¤º
            if (stocksValue > 0) {
                document.getElementById('stocksValue').textContent = '$' + formatNumber(stocksValue, 0);
                document.getElementById('stocksValueHKD').textContent = `(HKD ${formatNumber(stocksValue * USD_TO_HKD, 0)})`;
            } else {
                document.getElementById('stocksValue').textContent = '$0';
                document.getElementById('stocksValueHKD').textContent = '(HKD 0)';
            }
            
            // é¡¯ç¤ºç¸½ç›ˆè™§
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = (totalPnL >= 0 ? '+' : '') + '$' + formatNumber(totalPnL, 0);
            pnlElement.className = totalPnL >= 0 ? 'main-metric-value positive' : 'main-metric-value negative';
            document.getElementById('totalPnLHKD').textContent = `(HKD ${formatNumber(Math.abs(totalPnL) * USD_TO_HKD, 0)})`;
            
            // æ›´æ–°æ·¨æ¸…ç®—åƒ¹å€¼å’Œå¯ç”¨è³‡é‡‘
            if (portfolioData.account_summary) {
                // æ·¨æ¸…ç®—åƒ¹å€¼
                const netLiqData = portfolioData.account_summary.NetLiquidation;
                if (netLiqData && netLiqData.value) {
                    const netLiqHKD = parseFloat(netLiqData.value) || 0;
                    const netLiqUSD = netLiqHKD / USD_TO_HKD;
                    document.getElementById('netLiquidation').textContent = '$' + formatNumber(netLiqUSD, 0);
                    document.getElementById('netLiquidationHKD').textContent = `(HKD ${formatNumber(netLiqHKD, 0)})`;
                }
                
                // å¯ç”¨è³‡é‡‘
                const availFundsData = portfolioData.account_summary.AvailableFunds;
                if (availFundsData && availFundsData.value) {
                    const availFundsHKD = parseFloat(availFundsData.value) || 0;
                    const availFundsUSD = availFundsHKD / USD_TO_HKD;
                    document.getElementById('availableFunds').textContent = '$' + formatNumber(availFundsUSD, 0);
                    document.getElementById('availableFundsHKD').textContent = `(HKD ${formatNumber(availFundsHKD, 0)})`;
                }
            }
        }

        // æ›´æ–°åˆ°æœŸæ—¥åˆ†çµ„æ‘˜è¦
        function updateExpirySummary() {
            if (!portfolioData.options_by_expiry || portfolioData.options_by_expiry.length === 0) {
                document.getElementById('expirySummary').style.display = 'none';
                return;
            }

            document.getElementById('expirySummary').style.display = 'block';
            const container = document.getElementById('expiryCards');
            
            // æ’åºï¼šè¿‘æœŸåœ¨å‰
            const sortedExpiries = portfolioData.options_by_expiry.sort((a, b) => 
                a.expiry.localeCompare(b.expiry)
            );

            container.innerHTML = sortedExpiries.map(expiry => {
                const daysLeft = expiry.days_to_expiry || 0;
                let daysClass = '';
                let daysText = '';
                
                if (daysLeft <= 0) {
                    daysClass = 'urgent';
                    daysText = 'å·²åˆ°æœŸ';
                } else if (daysLeft <= 7) {
                    daysClass = 'urgent';
                    daysText = `å‰©é¤˜ ${daysLeft} å¤©`;
                } else {
                    daysText = `${daysLeft} å¤©`;
                }
                
                // åªè¨ˆç®—ç¾è‚¡æœŸæ¬Šçš„åˆ°æœŸåƒ¹å€¼å’Œç›ˆè™§
                let totalValueUSD = 0;
                let totalPnLUSD = 0;
                if (expiry.positions) {
                    expiry.positions.forEach(symbol => {
                        const pos = portfolioData.positions.find(p => p.symbol === symbol && p.expiry === expiry.expiry);
                        if (pos && pos.currency === 'USD') {
                            totalValueUSD += Math.abs(pos.market_value || 0);
                            
                            // è¨ˆç®—ç›ˆè™§
                            if (pos.pnl !== null && pos.pnl !== undefined) {
                                totalPnLUSD += pos.pnl;
                            }
                        }
                    });
                }

                const pnlClass = totalPnLUSD >= 0 ? 'positive' : 'negative';
                const pnlSign = totalPnLUSD >= 0 ? '+' : '';

                return `
                    <div class="expiry-card">
                        <div class="expiry-date">${expiry.expiry_formatted}</div>
                        <div class="days-left ${daysClass}">${daysText}</div>
                        <div class="expiry-value positive">$${formatNumber(totalValueUSD, 0)}</div>
                        <div class="expiry-value-hkd">HKD ${formatNumber(totalValueUSD * USD_TO_HKD, 0)}</div>
                        <div class="expiry-pnl ${pnlClass}">${pnlSign}$${formatNumber(Math.abs(totalPnLUSD), 0)}</div>
                        <div class="expiry-count">${expiry.count} å€‹æœŸæ¬Š</div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°æŒå€‰çµ±è¨ˆ
        function updatePositionStats() {
            const summary = portfolioData.summary || {};
            
            document.getElementById('totalPositions').textContent = summary.total_positions || 0;
            document.getElementById('optionsCount').textContent = summary.options_count || 0;
            document.getElementById('stocksCount').textContent = summary.stocks_count || 0;
            
            if (portfolioData.last_update) {
                const updateTime = new Date(portfolioData.last_update);
                const hours = updateTime.getHours().toString().padStart(2, '0');
                const minutes = updateTime.getMinutes().toString().padStart(2, '0');
                document.getElementById('lastUpdate').textContent = `${hours}:${minutes}`;
            }
        }

        // æ›´æ–°æ‰€æœ‰æŒå€‰è¡¨æ ¼
        function updateAllPositionsTables() {
            updateUSOptionsTable();
            updateHKOptionsTable();
            updateStocksTable();
        }
        
        // æ›´æ–°ç¾è‚¡æœŸæ¬Šè¡¨æ ¼
        function updateUSOptionsTable() {
            if (!portfolioData || !portfolioData.positions) return;

            // åªé¡¯ç¤ºç¾è‚¡æœŸæ¬Š
            let positions = portfolioData.positions.filter(p => p.secType === 'OPT' && p.currency === 'USD');

            // æ‡‰ç”¨éæ¿¾
            const filter = currentFilter.us;
            if (filter === 'expired') {
                positions = positions.filter(p => p.days_to_expiry <= 0);
            } else if (filter === '30days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 30);
            } else if (filter === '90days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 90);
            }

            // ç”Ÿæˆè¡¨æ ¼
            const tbody = document.getElementById('usOptionsTable');
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; color: #6c757d;">
                            ç„¡ç¬¦åˆæ¢ä»¶çš„æŒå€‰
                        </td>
                    </tr>
                `;
                return;
            }

            // æŒ‰åˆ°æœŸæ—¥å’Œæ¨™çš„æ’åº
            positions.sort((a, b) => {
                // å…ˆæŒ‰åˆ°æœŸæ—¥æ’åºï¼ˆè¿‘æœŸåœ¨å‰ï¼‰
                if (a.secType === 'OPT' && b.secType === 'OPT') {
                    const aExpiry = a.expiry || '99999999';
                    const bExpiry = b.expiry || '99999999';
                    if (aExpiry !== bExpiry) {
                        return aExpiry.localeCompare(bExpiry);
                    }
                }
                // å¦‚æœä¸€å€‹æ˜¯æœŸæ¬Šä¸€å€‹ä¸æ˜¯ï¼ŒæœŸæ¬Šåœ¨å‰
                if (a.secType === 'OPT' && b.secType !== 'OPT') return -1;
                if (a.secType !== 'OPT' && b.secType === 'OPT') return 1;
                // ç„¶å¾ŒæŒ‰æ¨™çš„æ’åº
                return a.symbol.localeCompare(b.symbol);
            });

            // æŒ‰åˆ°æœŸæ—¥åˆ†çµ„é¡¯ç¤º
            let html = '';
            let lastExpiry = '';
            
            positions.forEach(pos => {
                // å¦‚æœæ˜¯æœŸæ¬Šä¸”åˆ°æœŸæ—¥è®Šäº†ï¼Œæ’å…¥åˆ†éš”è¡Œ
                if (groupByExpiry.us && pos.expiry !== lastExpiry) {
                    lastExpiry = pos.expiry;
                    const expiryData = portfolioData.options_by_expiry?.find(e => e.expiry === lastExpiry);
                    let expiryLabel = `ğŸ“… åˆ°æœŸæ—¥: ${pos.expiry_formatted}`;
                    
                    const daysLeft = pos.days_to_expiry || 0;
                    if (daysLeft <= 0) {
                        expiryLabel += ' (å·²åˆ°æœŸ)';
                    } else {
                        expiryLabel += ` (${daysLeft} å¤©)`;
                    }
                    
                    if (expiryData) {
                        // è¨ˆç®—è©²åˆ°æœŸæ—¥çš„ç¾å…ƒåƒ¹å€¼
                        let totalValueUSD = 0;
                        positions.forEach(p => {
                            if (p.expiry === lastExpiry) {
                                if (p.currency === 'HKD') {
                                    totalValueUSD += Math.abs(p.market_value || 0) / USD_TO_HKD;
                                } else {
                                    totalValueUSD += Math.abs(p.market_value || 0);
                                }
                            }
                        });
                        expiryLabel += ` - åˆ°æœŸåƒ¹å€¼: $${formatNumber(totalValueUSD, 0)}`;
                    }
                    
                    html += `
                        <tr class="expiry-separator">
                            <td colspan="12">${expiryLabel}</td>
                        </tr>
                    `;
                }
                
                // é¡å‹åœ–æ¨™
                let typeIcon = '';
                if (pos.secType === 'OPT') {
                    if (pos.right === 'C') {
                        typeIcon = '<span class="option-type-badge call" title="Call Option">C</span>';
                    } else {
                        typeIcon = '<span class="option-type-badge put" title="Put Option">P</span>';
                    }
                } else if (pos.secType === 'STK') {
                    typeIcon = '<span class="option-type-badge stock" title="Stock">S</span>';
                }
                
                // åˆ°æœŸåƒ¹å€¼è¨ˆç®—
                let marketValue = pos.market_value || 0;
                let marketValueHKD = 0;
                
                // å°æ–¼æ¸¯å…ƒæœŸæ¬Šï¼Œå¸‚å€¼å·²ç¶“æ˜¯æ¸¯å…ƒï¼Œéœ€è¦è½‰æ›ç‚ºç¾å…ƒé¡¯ç¤º
                if (pos.currency === 'HKD') {
                    marketValueHKD = Math.abs(marketValue);
                    marketValue = marketValueHKD / USD_TO_HKD;
                } else {
                    marketValue = Math.abs(marketValue);
                    marketValueHKD = marketValue * USD_TO_HKD;
                }
                const strike = pos.strike || 0;
                
                // è™•ç†ç¾åƒ¹å’Œç›ˆè™§é¡¯ç¤º
                let currentPrice = pos.current_price || pos.market_data?.currentPrice || pos.market_data?.last || pos.market_data?.close || 0;
                let currentPriceDisplay = '$' + formatNumber(currentPrice, 2);
                let pnl = pos.pnl;
                let pnlClass = '';
                let pnlDisplay = '-';
                
                // å¦‚æœæ•¸æ“šä¸å¯ç”¨ï¼Œä½¿ç”¨"-"é¡¯ç¤º
                if (pos.data_unavailable === true) {
                    currentPriceDisplay = '-';
                    pnlDisplay = '-';
                } else if (pos.secType === 'OPT' && pos.position < 0) {
                    if (pnl === null || pnl === undefined) {
                        pnlDisplay = '-';
                    } else if (pnl !== 0) {
                        pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        pnlDisplay = '$' + formatNumber(pnl, 0);
                    }
                }
                
                html += `
                    <tr>
                        <td class="symbol-cell">
                            ${pos.symbol}
                        </td>
                        <td style="text-align: center;">${typeIcon}</td>
                        <td class="text-right">${pos.secType === 'OPT' ? '$' + formatNumber(strike, 0) : '-'}</td>
                        <td class="text-right underlying-price" data-symbol="${pos.tradingClass || pos.symbol}">
                            ${pos.secType === 'OPT' ? '<span class="loading-price">-</span>' : '-'}
                        </td>
                        <td class="text-right underlying-change" data-symbol="${pos.tradingClass || pos.symbol}">
                            ${pos.secType === 'OPT' ? '-' : '-'}
                        </td>
                        <td class="text-right">${formatNumber(pos.position, 0)}</td>
                        <td class="text-right">${pos.currency === 'HKD' ? 'HK$' : '$'}${formatNumber(pos.avg_cost)}</td>
                        <td class="text-right">${currentPriceDisplay}</td>
                        <td class="text-right positive">
                            $${formatNumber(marketValue, 0)}
                        </td>
                        <td class="text-right positive">
                            ${formatNumber(marketValueHKD, 0)}
                        </td>
                        <td>
                            ${pos.secType === 'OPT' ? 
                                `${pos.expiry_formatted || ''} (${pos.days_to_expiry || 0}å¤©)` : 
                                '-'}
                        </td>
                        <td class="text-right ${pnlClass}">
                            ${pnlDisplay}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // æ›´æ–°åº•å±¤è‚¡ç¥¨åƒ¹æ ¼
            displayUnderlyingPrices();
        }
        
        // æ›´æ–°æ¸¯è‚¡æœŸæ¬Šè¡¨æ ¼
        function updateHKOptionsTable() {
            if (!portfolioData || !portfolioData.positions) return;

            // åªé¡¯ç¤ºæ¸¯è‚¡æœŸæ¬Š
            let positions = portfolioData.positions.filter(p => p.secType === 'OPT' && p.currency === 'HKD');

            // æ‡‰ç”¨éæ¿¾
            const filter = currentFilter.hk;
            if (filter === 'expired') {
                positions = positions.filter(p => p.days_to_expiry <= 0);
            } else if (filter === '30days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 30);
            } else if (filter === '90days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 90);
            }

            // ç”Ÿæˆè¡¨æ ¼
            const tbody = document.getElementById('hkOptionsTable');
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #6c757d;">
                            ç„¡ç¬¦åˆæ¢ä»¶çš„æ¸¯è‚¡æœŸæ¬Š
                        </td>
                    </tr>
                `;
                return;
            }

            // æŒ‰åˆ°æœŸæ—¥å’Œæ¨™çš„æ’åº
            positions.sort((a, b) => {
                const aExpiry = a.expiry || '99999999';
                const bExpiry = b.expiry || '99999999';
                if (aExpiry !== bExpiry) {
                    return aExpiry.localeCompare(bExpiry);
                }
                return a.symbol.localeCompare(b.symbol);
            });

            // æŒ‰åˆ°æœŸæ—¥åˆ†çµ„é¡¯ç¤º
            let html = '';
            let lastExpiry = '';
            
            positions.forEach(pos => {
                // å¦‚æœåˆ°æœŸæ—¥è®Šäº†ï¼Œæ’å…¥åˆ†éš”è¡Œ
                if (groupByExpiry.hk && pos.expiry !== lastExpiry) {
                    lastExpiry = pos.expiry;
                    let expiryLabel = `ğŸ“… åˆ°æœŸæ—¥: ${pos.expiry_formatted}`;
                    
                    const daysLeft = pos.days_to_expiry || 0;
                    if (daysLeft <= 0) {
                        expiryLabel += ' (å·²åˆ°æœŸ)';
                    } else {
                        expiryLabel += ` (${daysLeft} å¤©)`;
                    }
                    
                    // è¨ˆç®—è©²åˆ°æœŸæ—¥çš„ç¸½åƒ¹å€¼
                    let totalValueHKD = 0;
                    positions.forEach(p => {
                        if (p.expiry === lastExpiry) {
                            totalValueHKD += Math.abs(p.market_value || 0);
                        }
                    });
                    expiryLabel += ` - åˆ°æœŸåƒ¹å€¼: HK$${formatNumber(totalValueHKD, 0)}`;
                    
                    html += `
                        <tr class="expiry-separator">
                            <td colspan="8">${expiryLabel}</td>
                        </tr>
                    `;
                }
                
                // é¡å‹åœ–æ¨™
                let typeIcon = '';
                if (pos.right === 'C') {
                    typeIcon = '<span class="option-type-badge call" title="Call Option">C</span>';
                } else {
                    typeIcon = '<span class="option-type-badge put" title="Put Option">P</span>';
                }
                
                // åˆ°æœŸåƒ¹å€¼è¨ˆç®—
                const marketValueHKD = Math.abs(pos.market_value || 0);
                const marketValueUSD = marketValueHKD / USD_TO_HKD;
                const strike = pos.strike || 0;
                
                html += `
                    <tr>
                        <td class="symbol-cell">${pos.symbol}</td>
                        <td style="text-align: center;">${typeIcon}</td>
                        <td class="text-right">HK$${formatNumber(strike, 0)}</td>
                        <td class="text-right">${formatNumber(pos.position, 0)}</td>
                        <td class="text-right">HK$${formatNumber(pos.avg_cost)}</td>
                        <td class="text-right positive">HK$${formatNumber(marketValueHKD, 0)}</td>
                        <td class="text-right positive">$${formatNumber(marketValueUSD, 0)}</td>
                        <td>${pos.expiry_formatted || ''} (${pos.days_to_expiry || 0}å¤©)</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // æ›´æ–°è‚¡ç¥¨è¡¨æ ¼
        function updateStocksTable() {
            if (!portfolioData || !portfolioData.positions) return;

            // åªé¡¯ç¤ºè‚¡ç¥¨
            let positions = portfolioData.positions.filter(p => p.secType === 'STK');

            // ç”Ÿæˆè¡¨æ ¼
            const tbody = document.getElementById('stocksTable');
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #6c757d;">
                            ç„¡è‚¡ç¥¨æŒå€‰
                        </td>
                    </tr>
                `;
                return;
            }

            // æŒ‰æ¨™çš„æ’åº
            positions.sort((a, b) => a.symbol.localeCompare(b.symbol));

            let html = '';
            
            positions.forEach(pos => {
                const priceData = underlyingPrices[pos.symbol];
                let currentPrice = 0;
                let priceChange = 0;
                let priceChangeClass = '';
                
                if (priceData) {
                    currentPrice = priceData.price || 0;
                    priceChange = priceData.changesPercentage || 0;
                    priceChangeClass = priceChange >= 0 ? 'positive' : 'negative';
                }
                
                // è¨ˆç®—å¸‚å€¼å’Œç›ˆè™§
                let marketValue = 0;
                let marketValueHKD = 0;
                let pnl = 0;
                let pnlPercent = 0;
                let pnlClass = '';
                let showPriceColumns = false;
                
                if (currentPrice > 0) {
                    marketValue = pos.position * currentPrice;
                    marketValueHKD = marketValue * USD_TO_HKD;
                    const cost = pos.position * pos.avg_cost;
                    pnl = marketValue - cost;
                    pnlPercent = cost > 0 ? (pnl / cost) * 100 : 0;
                    pnlClass = pnl >= 0 ? 'positive' : 'negative';
                    showPriceColumns = true;
                }
                
                if (showPriceColumns) {
                    html += `
                        <tr>
                            <td class="symbol-cell">${pos.symbol}</td>
                            <td class="text-right">$${formatNumber(currentPrice, 2)}</td>
                            <td class="text-right ${priceChangeClass}">
                                ${priceChange >= 0 ? '+' : ''}${formatNumber(priceChange, 2)}%
                            </td>
                            <td class="text-right">${formatNumber(pos.position, 0)}</td>
                            <td class="text-right">$${formatNumber(pos.avg_cost, 2)}</td>
                            <td class="text-right positive">$${formatNumber(marketValue, 0)}</td>
                            <td class="text-right positive">${formatNumber(marketValueHKD, 0)}</td>
                            <td class="text-right ${pnlClass}">$${formatNumber(Math.abs(pnl), 0)}</td>
                            <td class="text-right ${pnlClass}">${pnlPercent >= 0 ? '+' : ''}${formatNumber(pnlPercent, 2)}%</td>
                        </tr>
                    `;
                } else {
                    // æ²’æœ‰åƒ¹æ ¼æ•¸æ“šæ™‚ï¼Œåªé¡¯ç¤ºåŸºæœ¬ä¿¡æ¯
                    html += `
                        <tr>
                            <td class="symbol-cell">${pos.symbol}</td>
                            <td class="text-right" colspan="2">ç„¡åƒ¹æ ¼æ•¸æ“š</td>
                            <td class="text-right">${formatNumber(pos.position, 0)}</td>
                            <td class="text-right">$${formatNumber(pos.avg_cost, 2)}</td>
                            <td class="text-right" colspan="4">-</td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html;
        }

        // éæ¿¾æŒå€‰
        function filterPositions(type, section) {
            currentFilter[section] = type;
            
            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            const parent = event.target.parentElement;
            parent.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (section === 'us') {
                updateUSOptionsTable();
            } else if (section === 'hk') {
                updateHKOptionsTable();
            } else if (section === 'stock') {
                updateStocksTable();
            }
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            if (portfolioData && portfolioData.last_update) {
                document.getElementById('updateTime').textContent = portfolioData.last_update;
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num, decimals = 2) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        // æ ¼å¼åŒ–è²¨å¹£
        function formatCurrency(num) {
            const formatted = formatNumber(Math.abs(num), 0);
            return (num < 0 ? '-' : '') + '$' + formatted;
        }

        // ç²å–é¡å‹æ¨™ç±¤
        function getTypeLabel(secType) {
            const types = {
                'OPT': 'æœŸæ¬Š',
                'STK': 'è‚¡ç¥¨',
                'CASH': 'ç¾é‡‘'
            };
            return types[secType] || secType;
        }
        
        // ç²å–åº•å±¤è‚¡ç¥¨åƒ¹æ ¼
        async function fetchUnderlyingPrices() {
            if (!portfolioData || !portfolioData.positions) return;
            
            // æ”¶é›†æ‰€æœ‰æœŸæ¬Šçš„åº•å±¤è‚¡ç¥¨ç¬¦è™Ÿå’Œè‚¡ç¥¨æŒå€‰ç¬¦è™Ÿ
            const underlyingSymbols = new Set();
            portfolioData.positions.forEach(pos => {
                if (pos.secType === 'OPT' && pos.tradingClass) {
                    underlyingSymbols.add(pos.tradingClass);
                } else if (pos.secType === 'STK') {
                    // æ·»åŠ è‚¡ç¥¨æŒå€‰ç¬¦è™Ÿ
                    underlyingSymbols.add(pos.symbol);
                }
            });
            
            if (underlyingSymbols.size === 0) return;
            
            try {
                const response = await fetch('/api/stock-prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: Array.from(underlyingSymbols)
                    })
                });
                
                const data = await response.json();
                if (data.success && data.prices) {
                    underlyingPrices = data.prices;
                    displayUnderlyingPrices();
                }
            } catch (error) {
                console.error('Error fetching underlying prices:', error);
            }
        }
        
        // é¡¯ç¤ºåº•å±¤è‚¡ç¥¨åƒ¹æ ¼
        function displayUnderlyingPrices() {
            // æ›´æ–°åƒ¹æ ¼æ¬„ä½
            document.querySelectorAll('.underlying-price').forEach(cell => {
                const symbol = cell.getAttribute('data-symbol');
                if (symbol && underlyingPrices[symbol]) {
                    const priceData = underlyingPrices[symbol];
                    const price = priceData.price;
                    
                    if (price) {
                        cell.innerHTML = `$${formatNumber(price, 2)}`;
                    }
                }
            });
            
            // æ›´æ–°æ¼²è·Œå¹…æ¬„ä½
            document.querySelectorAll('.underlying-change').forEach(cell => {
                const symbol = cell.getAttribute('data-symbol');
                if (symbol && underlyingPrices[symbol]) {
                    const priceData = underlyingPrices[symbol];
                    const change = priceData.changesPercentage;
                    
                    if (change !== undefined) {
                        const changeClass = change >= 0 ? 'positive' : 'negative';
                        const changeSign = change >= 0 ? '+' : '';
                        cell.innerHTML = `<span class="${changeClass}">${changeSign}${formatNumber(change, 2)}%</span>`;
                    }
                }
            });
            
            // æ›´æ–°è‚¡ç¥¨è¡¨æ ¼ä»¥é¡¯ç¤ºæ–°åƒ¹æ ¼
            updateStocksTable();
        }
        
        // æ‰‹å‹•æ›´æ–°åº•å±¤è‚¡ç¥¨åƒ¹æ ¼
        async function updateUnderlyingPrices() {
            if (isUpdatingPrices) return;
            
            const btn = document.getElementById('updatePricesBtn');
            const originalHTML = btn.innerHTML;
            
            try {
                isUpdatingPrices = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
                btn.disabled = true;
                
                await fetchUnderlyingPrices();
                showNotification('è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°æˆåŠŸ', 'success');
            } catch (error) {
                showNotification('åƒ¹æ ¼æ›´æ–°å¤±æ•—', 'error');
            } finally {
                isUpdatingPrices = false;
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
        
        // åˆ‡æ›åˆ†çµ„é¡¯ç¤º
        function toggleGrouping(section) {
            if (section === 'us') {
                groupByExpiry.us = document.getElementById('groupByExpiryUS').checked;
                updateUSOptionsTable();
            } else if (section === 'hk') {
                groupByExpiry.hk = document.getElementById('groupByExpiryHK').checked;
                updateHKOptionsTable();
            }
        }
        
        // è¡¨æ ¼æ’åºåŠŸèƒ½
        function sortTable(column, section) {
            if (!portfolioData || !portfolioData.positions) return;
            
            const sortState = currentSort[section];
            
            // æ›´æ–°æ’åºç‹€æ…‹
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            
            // æ›´æ–°æ’åºåœ–æ¨™
            const tableId = section === 'us' ? 'usOptionsTable' : section === 'hk' ? 'hkOptionsTable' : 'stocksTable';
            const table = document.getElementById(tableId).closest('.table-responsive').previousElementSibling;
            
            table.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const currentHeader = table.querySelector(`.sortable[onclick="sortTable('${column}', '${section}')"] i`);
            if (currentHeader) {
                currentHeader.className = sortState.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            if (section === 'us') {
                updateUSOptionsTableWithSort();
            } else if (section === 'hk') {
                updateHKOptionsTableWithSort();
            } else if (section === 'stock') {
                updateStocksTableWithSort();
            }
        }
        
        // æ·»åŠ å¸¶æ’åºçš„æ›´æ–°å‡½æ•¸
        function updateUSOptionsTableWithSort() {
            if (!portfolioData || !portfolioData.positions) return;

            // åªé¡¯ç¤ºç¾è‚¡æœŸæ¬Š
            let positions = portfolioData.positions.filter(p => p.secType === 'OPT' && p.currency === 'USD');

            // æ‡‰ç”¨éæ¿¾
            const filter = currentFilter.us;
            if (filter === 'expired') {
                positions = positions.filter(p => p.days_to_expiry <= 0);
            } else if (filter === '30days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 30);
            } else if (filter === '90days') {
                positions = positions.filter(p => p.days_to_expiry > 0 && p.days_to_expiry <= 90);
            }
            
            // æ‡‰ç”¨æ’åº
            const sortState = currentSort.us;
            if (sortState.column) {
                positions.sort((a, b) => {
                    let aVal, bVal;
                    
                    switch(sortState.column) {
                        case 'symbol':
                            aVal = a.symbol;
                            bVal = b.symbol;
                            break;
                        case 'strike':
                            aVal = a.strike || 0;
                            bVal = b.strike || 0;
                            break;
                        case 'underlyingPrice':
                            aVal = underlyingPrices[a.tradingClass || a.symbol]?.price || 0;
                            bVal = underlyingPrices[b.tradingClass || b.symbol]?.price || 0;
                            break;
                        case 'underlyingChange':
                            aVal = underlyingPrices[a.tradingClass || a.symbol]?.changesPercentage || 0;
                            bVal = underlyingPrices[b.tradingClass || b.symbol]?.changesPercentage || 0;
                            break;
                        case 'position':
                            aVal = a.position || 0;
                            bVal = b.position || 0;
                            break;
                        case 'avgCost':
                            aVal = a.avg_cost || 0;
                            bVal = b.avg_cost || 0;
                            break;
                        case 'currentPrice':
                            aVal = a.current_price || 0;
                            bVal = b.current_price || 0;
                            break;
                        case 'marketValue':
                            aVal = Math.abs(a.market_value || 0);
                            bVal = Math.abs(b.market_value || 0);
                            break;
                        case 'daysToExpiry':
                            aVal = a.days_to_expiry !== undefined ? a.days_to_expiry : 999999;
                            bVal = b.days_to_expiry !== undefined ? b.days_to_expiry : 999999;
                            break;
                        case 'pnl':
                            aVal = a.pnl || 0;
                            bVal = b.pnl || 0;
                            break;
                        default:
                            aVal = 0;
                            bVal = 0;
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortState.direction === 'asc' ? 
                            aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return sortState.direction === 'asc' ? 
                            aVal - bVal : bVal - aVal;
                    }
                });
            } else if (groupByExpiry.us) {
                // å¦‚æœæ²’æœ‰æŒ‡å®šæ’åºä½†å•Ÿç”¨äº†åˆ†çµ„ï¼ŒæŒ‰åˆ°æœŸæ—¥å’Œæ¨™çš„æ’åº
                positions.sort((a, b) => {
                    const aExpiry = a.expiry || '99999999';
                    const bExpiry = b.expiry || '99999999';
                    if (aExpiry !== bExpiry) {
                        return aExpiry.localeCompare(bExpiry);
                    }
                    return a.symbol.localeCompare(b.symbol);
                });
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('usOptionsTable');
            let html = '';
            let lastExpiry = '';
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; color: #6c757d;">
                            ç„¡ç¬¦åˆæ¢ä»¶çš„ç¾è‚¡æœŸæ¬Š
                        </td>
                    </tr>
                `;
                return;
            }
            
            positions.forEach(pos => {
                // å¦‚æœå•Ÿç”¨åˆ†çµ„ä¸”åˆ°æœŸæ—¥è®Šäº†ï¼Œæ’å…¥åˆ†éš”è¡Œ
                if (groupByExpiry.us && pos.expiry !== lastExpiry) {
                    lastExpiry = pos.expiry;
                    let expiryLabel = `ğŸ“… åˆ°æœŸæ—¥: ${pos.expiry_formatted}`;
                    
                    const daysLeft = pos.days_to_expiry || 0;
                    if (daysLeft <= 0) {
                        expiryLabel += ' (å·²åˆ°æœŸ)';
                    } else {
                        expiryLabel += ` (${daysLeft} å¤©)`;
                    }
                    
                    // è¨ˆç®—è©²åˆ°æœŸæ—¥çš„ç¾å…ƒåƒ¹å€¼
                    let totalValueUSD = 0;
                    positions.forEach(p => {
                        if (p.expiry === lastExpiry) {
                            totalValueUSD += Math.abs(p.market_value || 0);
                        }
                    });
                    expiryLabel += ` - åˆ°æœŸåƒ¹å€¼: $${formatNumber(totalValueUSD, 0)}`;
                    
                    html += `
                        <tr class="expiry-separator">
                            <td colspan="12">${expiryLabel}</td>
                        </tr>
                    `;
                }
                
                // é¡å‹åœ–æ¨™
                let typeIcon = '';
                if (pos.right === 'C') {
                    typeIcon = '<span class="option-type-badge call" title="Call Option">C</span>';
                } else {
                    typeIcon = '<span class="option-type-badge put" title="Put Option">P</span>';
                }
                
                // åˆ°æœŸåƒ¹å€¼è¨ˆç®—
                const marketValue = Math.abs(pos.market_value || 0);
                const marketValueHKD = marketValue * USD_TO_HKD;
                const strike = pos.strike || 0;
                
                // è™•ç†ç¾åƒ¹å’Œç›ˆè™§é¡¯ç¤º
                let currentPrice = pos.current_price || pos.market_data?.currentPrice || pos.market_data?.last || pos.market_data?.close || 0;
                let currentPriceDisplay = '$' + formatNumber(currentPrice, 2);
                let pnl = pos.pnl;
                let pnlClass = '';
                let pnlDisplay = '-';
                
                if (pos.data_unavailable === true) {
                    currentPriceDisplay = '-';
                    pnlDisplay = '-';
                } else if (pos.position < 0) {
                    if (pnl === null || pnl === undefined) {
                        pnlDisplay = '-';
                    } else if (pnl !== 0) {
                        pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        pnlDisplay = '$' + formatNumber(pnl, 0);
                    }
                }
                
                html += `
                    <tr>
                        <td class="symbol-cell">${pos.symbol}</td>
                        <td style="text-align: center;">${typeIcon}</td>
                        <td class="text-right">$${formatNumber(strike, 0)}</td>
                        <td class="text-right underlying-price" data-symbol="${pos.tradingClass || pos.symbol}">
                            <span class="loading-price">-</span>
                        </td>
                        <td class="text-right underlying-change" data-symbol="${pos.tradingClass || pos.symbol}">-</td>
                        <td class="text-right">${formatNumber(pos.position, 0)}</td>
                        <td class="text-right">$${formatNumber(pos.avg_cost)}</td>
                        <td class="text-right">${currentPriceDisplay}</td>
                        <td class="text-right positive">$${formatNumber(marketValue, 0)}</td>
                        <td class="text-right positive">${formatNumber(marketValueHKD, 0)}</td>
                        <td>${pos.expiry_formatted || ''} (${pos.days_to_expiry || 0}å¤©)</td>
                        <td class="text-right ${pnlClass}">${pnlDisplay}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            displayUnderlyingPrices();
        }
        
        function updateHKOptionsTableWithSort() {
            // èˆ‡ updateHKOptionsTable ç›¸åŒçš„é‚è¼¯ï¼Œä½†åŠ å…¥æ’åº
            updateHKOptionsTable();
        }
        
        function updateStocksTableWithSort() {
            // èˆ‡ updateStocksTable ç›¸åŒçš„é‚è¼¯ï¼Œä½†åŠ å…¥æ’åº
            updateStocksTable();
        }
        
        // æ›´æ–°è³¬æˆ¶ä¿¡æ¯
        function updateAccountInfo() {
            if (!portfolioData || !portfolioData.account_values) return;
            
            const accountValues = portfolioData.account_values;
            
            // æ›´æ–°è³¬æˆ¶é¤˜é¡
            if (accountValues['CashBalance-USD']) {
                const cashUSD = parseFloat(accountValues['CashBalance-USD']) || 0;
                const cashHKD = cashUSD * USD_TO_HKD;
                const cashElement = document.getElementById('cashBalance');
                if (cashElement) {
                    cashElement.textContent = '$' + formatNumber(cashUSD, 0);
                    const hkdElement = document.getElementById('cashBalanceHKD');
                    if (hkdElement) {
                        hkdElement.textContent = `(HKD ${formatNumber(cashHKD, 0)})`;
                    }
                }
            }
        }
        
    </script>
</body>
</html>