<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB API 開發文檔與測試平台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        /* ===== 全局樣式重置 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* ===== 頂部導航 ===== */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-link {
            color: #666;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-link:hover {
            color: #667eea;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-loading { 
            background: #ffc107; 
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ===== 主容器布局 ===== */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
            background: white;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
        }
        
        /* ===== 左側導航 ===== */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            height: calc(100vh - 80px);
            overflow-y: auto;
            position: sticky;
            top: 80px;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .search-container {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .nav-menu {
            padding: 1rem 0;
        }
        
        .nav-section {
            margin-bottom: 0.5rem;
        }
        
        .nav-section-title {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nav-section-title:hover {
            background: #e9ecef;
            color: #667eea;
        }
        
        .nav-section-icon {
            transition: transform 0.2s;
        }
        
        .nav-section.collapsed .nav-section-icon {
            transform: rotate(-90deg);
        }
        
        .nav-items {
            background: white;
            border-left: 3px solid #e9ecef;
            margin-left: 1.5rem;
        }
        
        .nav-section.collapsed .nav-items {
            display: none;
        }
        
        .nav-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #666;
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background: #667eea;
            color: white;
            transform: translateX(3px);
        }
        
        .nav-item i {
            width: 16px;
            margin-right: 0.75rem;
        }
        
        /* ===== 主內容區域 ===== */
        .main-content {
            flex: 1;
            padding: 0;
            background: white;
            overflow-y: auto;
            height: calc(100vh - 80px);
        }
        
        .content-section {
            display: none;
            padding: 2rem;
            max-width: 900px;
        }
        
        .content-section.active {
            display: block;
        }
        
        .content-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .content-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .content-subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .content-body h2 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .content-body h3 {
            color: #495057;
            font-size: 1.25rem;
            margin: 1.5rem 0 0.75rem;
        }
        
        .content-body p {
            margin-bottom: 1rem;
            color: #555;
            line-height: 1.7;
        }
        
        .content-body ul, .content-body ol {
            margin: 1rem 0 1rem 2rem;
            color: #555;
        }
        
        .content-body li {
            margin-bottom: 0.5rem;
        }
        
        /* ===== 代碼示例 ===== */
        .code-example {
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .code-header {
            background: #2d3748;
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .code-lang {
            font-weight: 600;
        }
        
        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }
        
        .copy-btn:hover {
            background: #667eea;
        }
        
        .code-example pre {
            margin: 0;
            background: #1a202c !important;
            color: #e2e8f0 !important;
            padding: 1.5rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        /* ===== API端點樣式 ===== */
        .api-endpoint {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .endpoint-method {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-right: 1rem;
        }
        
        .method-get {
            background: #28a745;
            color: white;
        }
        
        .method-post {
            background: #007bff;
            color: white;
        }
        
        .endpoint-url {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #495057;
        }
        
        .endpoint-description {
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.875rem;
        }
        
        /* ===== 表格樣式 ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        /* ===== 測試面板 ===== */
        .test-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .test-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .test-panel h3 {
            margin-bottom: 1rem;
            color: #495057;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0.25rem 0.5rem 0.25rem 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .response-area {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
            color: #495057;
        }
        
        /* ===== 響應式設計 ===== */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .content-section {
                padding: 1rem;
            }
            
            .test-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== 滾動條樣式 ===== */
        .sidebar::-webkit-scrollbar,
        .main-content::-webkit-scrollbar,
        .response-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track,
        .main-content::-webkit-scrollbar-track,
        .response-area::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .sidebar::-webkit-scrollbar-thumb,
        .main-content::-webkit-scrollbar-thumb,
        .response-area::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover,
        .main-content::-webkit-scrollbar-thumb:hover,
        .response-area::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ===== 功能卡片 ===== */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }
        
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .feature-card h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* ===== 警告和提示框 ===== */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #e7f3ff;
            border-color: #667eea;
            color: #004085;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                IB API 開發文檔
            </div>
            <nav class="header-nav">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    主控台
                </a>
                <a href="#" class="nav-link" onclick="checkConnectionStatus()">
                    <span class="status-indicator status-loading" id="connectionStatus"></span>
                    TWS 狀態
                </a>
            </nav>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="container">
        <!-- 左側導航 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">API 開發指南</div>
                <div class="sidebar-subtitle">Interactive Brokers TWS API</div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-box" placeholder="搜索文檔..." id="searchBox">
            </div>
            
            <nav class="nav-menu">
                <!-- 快速開始 -->
                <div class="nav-section">
                    <div class="nav-section-title" onclick="toggleSection(this)">
                        <span>快速開始</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-items">
                        <a href="#overview" class="nav-item active" onclick="showSection('overview')">
                            <i class="fas fa-info-circle"></i>系統概述
                        </a>
                        <a href="#installation" class="nav-item" onclick="showSection('installation')">
                            <i class="fas fa-download"></i>安裝配置
                        </a>
                        <a href="#authentication" class="nav-item" onclick="showSection('authentication')">
                            <i class="fas fa-key"></i>連接認證
                        </a>
                    </div>
                </div>
                
                <!-- API 端點 -->
                <div class="nav-section">
                    <div class="nav-section-title" onclick="toggleSection(this)">
                        <span>API 端點</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-items">
                        <a href="#portfolio-api" class="nav-item" onclick="showSection('portfolio-api')">
                            <i class="fas fa-briefcase"></i>持倉數據
                        </a>
                        <a href="#market-data-api" class="nav-item" onclick="showSection('market-data-api')">
                            <i class="fas fa-chart-bar"></i>市場數據
                        </a>
                        <a href="#account-api" class="nav-item" onclick="showSection('account-api')">
                            <i class="fas fa-user-circle"></i>賬戶信息
                        </a>
                    </div>
                </div>
                
                <!-- 開發指南 -->
                <div class="nav-section">
                    <div class="nav-section-title" onclick="toggleSection(this)">
                        <span>開發指南</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-items">
                        <a href="#client-architecture" class="nav-item" onclick="showSection('client-architecture')">
                            <i class="fas fa-code"></i>客戶端架構
                        </a>
                        <a href="#error-handling" class="nav-item" onclick="showSection('error-handling')">
                            <i class="fas fa-exclamation-triangle"></i>錯誤處理
                        </a>
                        <a href="#best-practices" class="nav-item" onclick="showSection('best-practices')">
                            <i class="fas fa-star"></i>最佳實踐
                        </a>
                    </div>
                </div>
                
                <!-- 測試工具 -->
                <div class="nav-section">
                    <div class="nav-section-title" onclick="toggleSection(this)">
                        <span>測試工具</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-items">
                        <a href="#api-testing" class="nav-item" onclick="showSection('api-testing')">
                            <i class="fas fa-flask"></i>API 測試
                        </a>
                        <a href="#monitoring" class="nav-item" onclick="showSection('monitoring')">
                            <i class="fas fa-heartbeat"></i>實時監控
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- 主內容區域 -->
        <main class="main-content">
            <!-- 系統概述 -->
            <section id="overview" class="content-section active">
                <div class="content-header">
                    <h1 class="content-title">系統概述</h1>
                    <p class="content-subtitle">Interactive Brokers TWS API 開發平台</p>
                </div>
                <div class="content-body">
                    <p>本平台基於 Interactive Brokers TWS API 構建，提供完整的量化交易和投資組合管理解決方案。系統採用 EnhancedIBClient 架構，支持實時數據獲取、自動化交易和風險管理。</p>
                    
                    <h2>核心特性</h2>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4><i class="fas fa-chart-line"></i>實時市場數據</h4>
                            <p>獲取股票、期權、期貨的實時價格、Greeks值和歷史數據，支持多種數據源整合。</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-briefcase"></i>持倉管理</h4>
                            <p>自動獲取持倉信息、計算盈虧和風險指標，支持期權到期價值計算。</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-robot"></i>自動化交易</h4>
                            <p>程序化下單、風險控制和策略執行，內建多重安全驗證機制。</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-shield-alt"></i>風險控制</h4>
                            <p>智能風險評估、持倉監控和自動止損，確保交易安全。</p>
                        </div>
                    </div>
                    
                    <h2>架構優勢</h2>
                    <ul>
                        <li><strong>事件驅動架構</strong> - 高效處理異步回調和實時數據</li>
                        <li><strong>線程安全設計</strong> - 支持並發操作和多線程環境</li>
                        <li><strong>錯誤恢復機制</strong> - 智能重連和分類錯誤處理</li>
                        <li><strong>數據持久化</strong> - 自動保存和緩存，支持斷線重連</li>
                        <li><strong>模塊化設計</strong> - 易於擴展和維護</li>
                    </ul>
                    
                    <div class="alert alert-info">
                        <strong><i class="fas fa-info-circle"></i> 系統要求：</strong>
                        Python 3.11+、TWS Build 952.x+、穩定網絡連接、IB 賬戶（實盤或紙交易）
                    </div>
                </div>
            </section>

            <!-- 安裝配置 -->
            <section id="installation" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">安裝配置</h1>
                    <p class="content-subtitle">環境設置和依賴安裝</p>
                </div>
                <div class="content-body">
                    <h2>Python 環境設置</h2>
                    <p>推薦使用虛擬環境來管理項目依賴：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Bash</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-bash"># 創建虛擬環境
python3.11 -m venv ib_env
source ib_env/bin/activate  # Linux/Mac
# 或 ib_env\Scripts\activate  # Windows

# 安裝核心依賴
pip install ibapi flask pandas numpy requests python-dotenv

# 安裝可選依賴
pip install psutil cryptography supervisor</code></pre>
                    </div>
                    
                    <h2>TWS/IB Gateway 配置</h2>
                    <ol>
                        <li>啟動 TWS 或 IB Gateway</li>
                        <li>進入 <code>API → Settings → Enable ActiveX and Socket Clients</code></li>
                        <li>設置 Socket port (默認: 7496 for TWS, 4001 for Gateway)</li>
                        <li>勾選 "Read-Only API"（生產環境推薦）</li>
                        <li>設置 Trusted IP addresses</li>
                        <li>配置 Master API client ID</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle"></i> 安全提醒：</strong>
                        首次使用建議先使用紙交易賬戶進行測試，確保所有功能正常後再連接真實賬戶。
                    </div>
                    
                    <h2>環境變量配置</h2>
                    <p>創建 <code>.env</code> 文件並配置以下參數：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Environment</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-bash"># TWS 連接設置
TWS_HOST=127.0.0.1
TWS_PORT=7496
CLIENT_ID=9999
TARGET_ACCOUNT=U1234567

# Flask 配置
FLASK_ENV=development
SECRET_KEY=your-secret-key-here
PORT=8080

# 外部 API 密鑰
FMP_API_KEY=your-financial-modeling-prep-key

# 監控配置
LOG_LEVEL=INFO
AUTO_UPDATE_INTERVAL=300</code></pre>
                    </div>
                </div>
            </section>

            <!-- 連接認證 -->
            <section id="authentication" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">連接認證</h1>
                    <p class="content-subtitle">建立與 TWS 的安全連接</p>
                </div>
                <div class="content-body">
                    <h2>基本連接流程</h2>
                    <p>EnhancedIBClient 使用標準的 TWS API 連接流程：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Python</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-python">from ibapi.client import EClient
from ibapi.wrapper import EWrapper
import threading

class EnhancedIBClient(EWrapper, EClient):
    def __init__(self):
        EClient.__init__(self, self)
        
        # 連接狀態管理
        self.connected = False
        self.connection_ready = threading.Event()
        
    def connectAck(self):
        """連接確認回調"""
        logger.info("Connected to TWS")
        self.connected = True
        
    def nextValidId(self, orderId: int):
        """接收有效訂單ID，標誌連接完成"""
        logger.info(f"Next Valid Order ID: {orderId}")
        self.connection_ready.set()
        
    def connect_to_tws(self):
        """建立 TWS 連接"""
        # 啟動 API 線程
        api_thread = threading.Thread(target=self.run, daemon=True)
        api_thread.start()
        
        # 連接到 TWS
        self.connect('127.0.0.1', 7496, clientId=9999)
        
        # 等待連接建立
        if self.connection_ready.wait(timeout=10):
            logger.info("TWS 連接成功")
            return True
        else:
            logger.error("TWS 連接超時")
            return False</code></pre>
                    </div>
                    
                    <h2>連接參數說明</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>參數</th>
                                <th>默認值</th>
                                <th>說明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>host</code></td>
                                <td>127.0.0.1</td>
                                <td>TWS 運行的主機地址</td>
                            </tr>
                            <tr>
                                <td><code>port</code></td>
                                <td>7496</td>
                                <td>TWS API 端口 (Gateway: 4001)</td>
                            </tr>
                            <tr>
                                <td><code>clientId</code></td>
                                <td>9999</td>
                                <td>客戶端 ID，避免與其他應用衝突</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-info">
                        <strong><i class="fas fa-lightbulb"></i> 提示：</strong>
                        高客戶端 ID（如 9999）可避免與其他 IB 應用程序的衝突。生產環境建議使用 Read-Only API 模式。
                    </div>
                </div>
            </section>

            <!-- 持倉數據 API -->
            <section id="portfolio-api" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">持倉數據 API</h1>
                    <p class="content-subtitle">獲取和管理投資組合信息</p>
                </div>
                <div class="content-body">
                    <h2>API 端點概覽</h2>
                    
                    <div class="api-endpoint">
                        <div>
                            <span class="endpoint-method method-get">GET</span>
                            <span class="endpoint-url">/api/portfolio</span>
                        </div>
                        <div class="endpoint-description">
                            獲取完整的持倉數據，包括期權、股票和賬戶摘要信息
                        </div>
                    </div>
                    
                    <div class="api-endpoint">
                        <div>
                            <span class="endpoint-method method-post">POST</span>
                            <span class="endpoint-url">/api/update</span>
                        </div>
                        <div class="endpoint-description">
                            手動觸發持倉數據更新，從 TWS 重新獲取最新信息
                        </div>
                    </div>
                    
                    <h2>數據結構示例</h2>
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">JSON Response</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-json">{
  "timestamp": "2025-06-25T08:03:30",
  "last_update": "2025-06-25 08:03:30",
  "positions": [
    {
      "symbol": "AAPL",
      "secType": "OPT",
      "position": -10.0,
      "avgCost": 992.54926,
      "currency": "USD",
      "strike": 150.0,
      "right": "P",
      "expiry": "20250919",
      "market_data": {
        "currentPrice": 9.27,
        "bid": 9.2,
        "ask": 9.35
      },
      "pnl": 655.49,
      "market_value": -9270.00
    }
  ],
  "summary": {
    "net_liquidation": 100000,
    "total_cash": 50000,
    "us_options_expiration_value": 5000
  }
}</code></pre>
                    </div>
                </div>
            </section>

            <!-- 市場數據 API -->
            <section id="market-data-api" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">市場數據 API</h1>
                    <p class="content-subtitle">實時價格和期權 Greeks 數據</p>
                </div>
                <div class="content-body">
                    <h2>數據訂閱機制</h2>
                    <p>系統自動為所有持倉訂閱實時市場數據，包括價格、成交量和期權 Greeks：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Python</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-python">def subscribe_market_data(self, contract, symbol):
    """訂閱市場數據"""
    req_id = self.nextReqId()
    self.map_request(req_id, symbol, 'market_data')
    
    # 訂閱實時數據，包括期權 Greeks
    generic_tick_list = "233"  # 包括 RTVolume 和期權計算
    self.reqMktData(req_id, contract, generic_tick_list, False, False, [])
    
    logger.info(f"Subscribing to market data: {symbol} (reqId: {req_id})")

def tickPrice(self, reqId, tickType, price, attrib):
    """處理價格 tick 數據"""
    symbol = self.get_symbol_from_reqid(reqId)
    if not symbol:
        return
    
    # 映射 tick 類型到字段名
    tick_map = {
        1: 'bid',           # BID
        2: 'ask',           # ASK  
        4: 'last',          # LAST
        9: 'close',         # CLOSE
    }
    
    if tickType in tick_map:
        field_name = tick_map[tickType]
        if symbol not in self.market_data:
            self.market_data[symbol] = {}
        self.market_data[symbol][field_name] = price</code></pre>
                    </div>
                    
                    <h2>數據類型說明</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>TickType</th>
                                <th>描述</th>
                                <th>用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>BID (1)</code></td>
                                <td>買入價</td>
                                <td>計算買賣價差</td>
                            </tr>
                            <tr>
                                <td><code>ASK (2)</code></td>
                                <td>賣出價</td>
                                <td>計算買賣價差</td>
                            </tr>
                            <tr>
                                <td><code>LAST (4)</code></td>
                                <td>最新成交價</td>
                                <td>當前市價參考</td>
                            </tr>
                            <tr>
                                <td><code>VOLUME (8)</code></td>
                                <td>成交量</td>
                                <td>流動性評估</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 賬戶信息 API -->
            <section id="account-api" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">賬戶信息 API</h1>
                    <p class="content-subtitle">賬戶數據和資金管理</p>
                </div>
                <div class="content-body">
                    <h2>賬戶摘要數據</h2>
                    <p>系統自動獲取並處理賬戶摘要信息，包括淨清算價值、現金餘額等：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Python</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-python">def requestAccountSummary(self):
    """請求賬戶摘要數據"""
    # 請求關鍵賬戶數據
    tags = "NetLiquidation,TotalCashValue,GrossPositionValue,BuyingPower"
    self.reqAccountSummary(9001, "All", tags)

def accountSummary(self, reqId: int, account: str, tag: str, 
                  value: str, currency: str):
    """處理賬戶摘要回調"""
    if account not in self.account_summary:
        self.account_summary[account] = {}
        
    # 轉換並存儲賬戶數據
    try:
        numeric_value = float(value) if value else 0.0
        self.account_summary[account][tag] = {
            'value': numeric_value,
            'currency': currency,
            'raw': value
        }
    except ValueError:
        # 處理非數值型數據
        self.account_summary[account][tag] = {
            'value': value,
            'currency': currency,
            'raw': value
        }</code></pre>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong><i class="fas fa-check-circle"></i> 安全設計：</strong>
                        系統自動隱藏敏感的賬戶信息，僅顯示前兩位字符以保護隱私。
                    </div>
                </div>
            </section>

            <!-- 客戶端架構 -->
            <section id="client-architecture" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">客戶端架構</h1>
                    <p class="content-subtitle">EnhancedIBClient 設計模式</p>
                </div>
                <div class="content-body">
                    <h2>多重繼承適配器模式</h2>
                    <p>EnhancedIBClient 採用了 EWrapper 和 EClient 的多重繼承設計，提供統一的 API 接口：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Python</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-python">class EnhancedIBClient(EWrapper, EClient):
    """
    Enhanced IB API 客戶端
    
    使用多重繼承適配器模式，結合了 EWrapper（事件處理）
    和 EClient（API 通信）的功能，提供統一的接口。
    
    核心特性：
    - 事件驅動架構
    - 線程安全操作
    - 自動重連機制
    - 數據持久化
    - 錯誤分類處理
    """
    
    def __init__(self):
        # 初始化父類
        EClient.__init__(self, self)
        
        # 連接管理
        self.connected = False
        self.connection_ready = threading.Event()
        self.account = None
        
        # 數據存儲
        self.positions = {}
        self.market_data = {}
        self.account_summary = {}
        
        # 線程同步
        self.update_lock = threading.Lock()
        self.update_complete = threading.Event()</code></pre>
                    </div>
                    
                    <h2>線程模型</h2>
                    <p>系統採用多線程架構確保響應性和線程安全：</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4><i class="fas fa-server"></i>主線程</h4>
                            <p>Flask web 服務器，處理 HTTP 請求和響應</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-exchange-alt"></i>API 線程</h4>
                            <p>EClient.run() 守護線程，處理 TWS 通信</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-sync-alt"></i>更新線程</h4>
                            <p>定期自動更新，後台數據同步</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 錯誤處理 -->
            <section id="error-handling" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">錯誤處理</h1>
                    <p class="content-subtitle">智能錯誤分類和恢復機制</p>
                </div>
                <div class="content-body">
                    <h2>錯誤分類策略</h2>
                    <p>系統採用智能錯誤分類機制，針對不同類型的錯誤採取相應的處理策略：</p>
                    
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Python</span>
                            <button class="copy-btn" onclick="copyCode(this)">複製</button>
                        </div>
                        <pre><code class="language-python">def error(self, reqId: int, errorCode: int, errorString: str):
    """分類處理 TWS API 錯誤"""
    # 資訊類錯誤 - 可忽略
    if errorCode in [2104, 2106, 2158]:
        logger.info(f"Info: {errorString}")
        return
    
    # 預期錯誤 - 記錄警告
    if errorCode in [200, 354, 162]:
        logger.warning(f"Expected: {errorString}")
        if reqId in self.subscription_errors:
            self.subscription_errors[reqId] = errorString
        return
    
    # 真正錯誤 - 需要處理
    logger.error(f"Error {errorCode}: {errorString}")
    
    # 連接相關錯誤
    if errorCode in [502, 504, 1100, 1101, 1102]:
        self.handle_connection_error(errorCode, errorString)
    
    # 市場數據錯誤
    elif 300 <= errorCode < 400:
        self.handle_market_data_error(reqId, errorCode, errorString)</code></pre>
                    </div>
                    
                    <h2>常見錯誤解決方案</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>錯誤代碼</th>
                                <th>描述</th>
                                <th>解決方案</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>162</code></td>
                                <td>需要 BATS 市場數據訂閱</td>
                                <td>聯繫 IB 或使用延遲數據</td>
                            </tr>
                            <tr>
                                <td><code>200</code></td>
                                <td>證券定義未找到</td>
                                <td>檢查合約參數</td>
                            </tr>
                            <tr>
                                <td><code>502</code></td>
                                <td>無法連接到 TWS</td>
                                <td>檢查 TWS 是否運行</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 最佳實踐 -->
            <section id="best-practices" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">最佳實踐</h1>
                    <p class="content-subtitle">開發和部署建議</p>
                </div>
                <div class="content-body">
                    <h2>開發建議</h2>
                    <ul>
                        <li><strong>使用虛擬環境</strong> - 隔離項目依賴，避免版本衝突</li>
                        <li><strong>錯誤處理</strong> - 始終檢查 TWS 連接狀態，妥善處理異常</li>
                        <li><strong>數據持久化</strong> - 定期保存重要數據，支持斷線恢復</li>
                        <li><strong>日誌記錄</strong> - 詳細記錄操作日誌，便於調試和監控</li>
                        <li><strong>測試驗證</strong> - 先在紙交易環境測試，確保穩定後上線</li>
                    </ul>
                    
                    <h2>安全考慮</h2>
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-shield-alt"></i> 安全提醒：</strong>
                        <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                            <li>永不在代碼中硬編碼賬戶信息和密鑰</li>
                            <li>使用環境變量存儲敏感配置</li>
                            <li>啟用 Read-Only API 模式（生產環境）</li>
                            <li>定期更新依賴庫和安全補丁</li>
                            <li>實施適當的訪問控制和審計</li>
                        </ul>
                    </div>
                    
                    <h2>性能優化</h2>
                    <ul>
                        <li><strong>批量請求</strong> - 合併相似的 API 請求，減少網絡開銷</li>
                        <li><strong>緩存機制</strong> - 適當緩存靜態數據，避免重複請求</li>
                        <li><strong>線程管理</strong> - 合理使用線程池，避免資源浪費</li>
                        <li><strong>內存管理</strong> - 及時清理無用數據，避免內存洩漏</li>
                    </ul>
                </div>
            </section>

            <!-- API 測試 -->
            <section id="api-testing" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">API 測試平台</h1>
                    <p class="content-subtitle">實時測試和調試工具</p>
                </div>
                <div class="content-body">
                    <h2>連接狀態檢查</h2>
                    <div class="test-panel">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="status-indicator status-loading" id="testConnectionStatus"></span>
                                <span><strong>TWS 連接狀態:</strong> <span id="connectionStatusText">檢查中...</span></span>
                            </div>
                            <button class="test-button" onclick="checkConnectionStatus()">
                                <i class="fas fa-sync"></i>重新檢查
                            </button>
                        </div>
                        <div id="connectionDetails" style="font-size: 0.875rem; color: #666;"></div>
                    </div>
                    
                    <h2>API 端點測試</h2>
                    <div class="test-container">
                        <div class="test-panel">
                            <h3>持倉數據測試</h3>
                            <button class="test-button" onclick="testPortfolioAPI()">
                                <i class="fas fa-briefcase"></i>獲取持倉數據
                            </button>
                            <button class="test-button" onclick="testUpdateAPI()">
                                <i class="fas fa-sync"></i>更新持倉
                            </button>
                            <div class="response-area" id="portfolioResponse">點擊上方按鈕測試 API...</div>
                        </div>
                        
                        <div class="test-panel">
                            <h3>系統狀態測試</h3>
                            <button class="test-button" onclick="testStatusAPI()">
                                <i class="fas fa-heartbeat"></i>系統健康檢查
                            </button>
                            <button class="test-button" onclick="testPerformanceAPI()">
                                <i class="fas fa-tachometer-alt"></i>性能測試
                            </button>
                            <div class="response-area" id="statusResponse">點擊上方按鈕測試 API...</div>
                        </div>
                    </div>
                    
                    <h2>開發者控制台</h2>
                    <div class="code-example">
                        <div class="code-header">
                            <span class="code-lang">Console Log</span>
                            <button class="copy-btn" onclick="clearConsole()">清除</button>
                        </div>
                        <div class="response-area" id="developerConsole" style="height: 200px; font-family: 'Courier New', monospace;">
開發者控制台 - 實時 API 調用日誌
============================================
系統啟動時間: ${new Date().toLocaleString()}
當前環境: Development
TWS API 版本: 9.72+
============================================
                        </div>
                    </div>
                </div>
            </section>

            <!-- 實時監控 -->
            <section id="monitoring" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">實時監控</h1>
                    <p class="content-subtitle">系統性能和數據流監控</p>
                </div>
                <div class="content-body">
                    <h2>實時數據監控</h2>
                    <div class="test-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>市場數據流</h3>
                            <button class="test-button" onclick="toggleRealTimeMonitoring()">
                                <i class="fas fa-play"></i>
                                <span id="monitoringToggleText">開始監控</span>
                            </button>
                        </div>
                        <div class="response-area" id="realTimeData" style="height: 300px;">實時數據將在此顯示...</div>
                    </div>
                    
                    <h2>系統指標</h2>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4><i class="fas fa-chart-line"></i>API 響應時間</h4>
                            <p id="apiResponseTime">檢測中...</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-database"></i>數據更新頻率</h4>
                            <p id="dataUpdateFreq">檢測中...</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-wifi"></i>連接穩定性</h4>
                            <p id="connectionStability">檢測中...</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-exclamation-triangle"></i>錯誤統計</h4>
                            <p id="errorStats">檢測中...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // 全局變量
        let isMonitoring = false;
        let monitoringInterval = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkConnectionStatus();
            setupSearch();
            initializeNavigation();
            addConsoleMessage('系統初始化完成');
        });
        
        // 搜索功能
        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                filterNavigation(query);
            });
        }
        
        function filterNavigation(query) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) || query === '' ? 'block' : 'none';
            });
        }
        
        // 導航功能
        function initializeNavigation() {
            // 默認展開所有部分
            const sections = document.querySelectorAll('.nav-section');
            sections.forEach(section => {
                section.classList.remove('collapsed');
            });
        }
        
        function toggleSection(element) {
            const section = element.parentElement;
            section.classList.toggle('collapsed');
        }
        
        function showSection(sectionId) {
            // 隱藏所有內容區域
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // 顯示目標區域
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // 更新導航活動狀態
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[href="#${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            addConsoleMessage(`切換到: ${sectionId}`);
        }
        
        // API 測試功能
        async function checkConnectionStatus() {
            const statusIndicator = document.getElementById('testConnectionStatus');
            const statusText = document.getElementById('connectionStatusText');
            const detailsDiv = document.getElementById('connectionDetails');
            const headerStatus = document.getElementById('connectionStatus');
            
            statusIndicator.className = 'status-indicator status-loading';
            headerStatus.className = 'status-indicator status-loading';
            statusText.textContent = '檢查中...';
            
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.tws_connected) {
                    statusIndicator.className = 'status-indicator status-online';
                    headerStatus.className = 'status-indicator status-online';
                    statusText.textContent = '已連接';
                    detailsDiv.innerHTML = `
                        <div>持倉數量: ${data.positions_count || 0}</div>
                        <div>最後更新: ${data.last_update || 'N/A'}</div>
                        <div>服務器時間: ${new Date().toLocaleString()}</div>
                    `;
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    headerStatus.className = 'status-indicator status-offline';
                    statusText.textContent = '未連接';
                    detailsDiv.innerHTML = '<div style="color: #dc3545;">TWS 連接失敗，請檢查 TWS 是否運行並啟用 API</div>';
                }
                
                addConsoleMessage(`連接狀態檢查: ${data.tws_connected ? '成功' : '失敗'}`);
                
            } catch (error) {
                statusIndicator.className = 'status-indicator status-offline';
                headerStatus.className = 'status-indicator status-offline';
                statusText.textContent = '錯誤';
                detailsDiv.innerHTML = `<div style="color: #dc3545;">檢查失敗: ${error.message}</div>`;
                addConsoleMessage(`連接檢查錯誤: ${error.message}`);
            }
        }
        
        async function testPortfolioAPI() {
            const responseArea = document.getElementById('portfolioResponse');
            responseArea.textContent = '正在獲取持倉數據...';
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                responseArea.textContent = `響應時間: ${duration}ms\n持倉數量: ${data.positions?.length || 0}\n\n` + JSON.stringify(data, null, 2).substring(0, 1000) + '...';
                addConsoleMessage(`持倉 API 測試成功 (${duration}ms)`);
                
            } catch (error) {
                responseArea.textContent = `錯誤: ${error.message}`;
                addConsoleMessage(`持倉 API 測試失敗: ${error.message}`);
            }
        }
        
        async function testUpdateAPI() {
            const responseArea = document.getElementById('portfolioResponse');
            responseArea.textContent = '正在更新持倉數據...';
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/update', { method: 'POST' });
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                responseArea.textContent = `響應時間: ${duration}ms\n\n` + JSON.stringify(data, null, 2);
                addConsoleMessage(`更新 API 測試成功 (${duration}ms)`);
                
            } catch (error) {
                responseArea.textContent = `錯誤: ${error.message}`;
                addConsoleMessage(`更新 API 測試失敗: ${error.message}`);
            }
        }
        
        async function testStatusAPI() {
            const responseArea = document.getElementById('statusResponse');
            responseArea.textContent = '正在檢查系統狀態...';
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/status');
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                responseArea.textContent = `響應時間: ${duration}ms\n\n` + JSON.stringify(data, null, 2);
                addConsoleMessage(`狀態 API 測試成功 (${duration}ms)`);
                
            } catch (error) {
                responseArea.textContent = `錯誤: ${error.message}`;
                addConsoleMessage(`狀態 API 測試失敗: ${error.message}`);
            }
        }
        
        async function testPerformanceAPI() {
            const responseArea = document.getElementById('statusResponse');
            responseArea.textContent = '正在執行性能測試...';
            
            const tests = [
                { name: '持倉數據', url: '/api/portfolio' },
                { name: '系統狀態', url: '/api/status' },
            ];
            
            let results = '性能測試結果:\n';
            
            for (const test of tests) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(test.url);
                    const duration = Date.now() - startTime;
                    
                    results += `${test.name}: ${duration}ms ${response.ok ? '✓' : '✗'}\n`;
                    addConsoleMessage(`${test.name}: ${duration}ms ${response.ok ? '✓' : '✗'}`);
                } catch (error) {
                    results += `${test.name}: 錯誤 - ${error.message}\n`;
                    addConsoleMessage(`${test.name}: 錯誤 - ${error.message}`);
                }
            }
            
            responseArea.textContent = results;
            addConsoleMessage('性能測試完成');
        }
        
        function toggleRealTimeMonitoring() {
            const button = document.querySelector('[onclick="toggleRealTimeMonitoring()"]');
            const toggleText = document.getElementById('monitoringToggleText');
            const dataArea = document.getElementById('realTimeData');
            
            if (!isMonitoring) {
                isMonitoring = true;
                toggleText.textContent = '停止監控';
                button.style.background = '#dc3545';
                
                // 開始監控
                monitoringInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/portfolio');
                        const data = await response.json();
                        
                        const timestamp = new Date().toLocaleTimeString();
                        const summary = `[${timestamp}] 持倉: ${data.positions?.length || 0}, 淨值: ${data.summary?.net_liquidation || 'N/A'}`;
                        
                        dataArea.textContent = summary + '\n' + dataArea.textContent.split('\n').slice(0, 19).join('\n');
                        
                    } catch (error) {
                        const timestamp = new Date().toLocaleTimeString();
                        const errorMsg = `[${timestamp}] 錯誤: ${error.message}`;
                        dataArea.textContent = errorMsg + '\n' + dataArea.textContent.split('\n').slice(0, 19).join('\n');
                    }
                }, 2000);
                
                addConsoleMessage('開始實時監控');
                
            } else {
                isMonitoring = false;
                toggleText.textContent = '開始監控';
                button.style.background = '';
                
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
                
                addConsoleMessage('停止實時監控');
            }
        }
        
        // 工具函數
        function addConsoleMessage(message) {
            const console = document.getElementById('developerConsole');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.textContent = console.textContent + '\n' + logEntry;
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            const console = document.getElementById('developerConsole');
            console.textContent = `開發者控制台 - 實時 API 調用日誌
============================================
系統啟動時間: ${new Date().toLocaleString()}
當前環境: Development
TWS API 版本: 9.72+
============================================`;
        }
        
        function copyCode(button) {
            const codeBlock = button.closest('.code-example').querySelector('code');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '已複製';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }
        
        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'k':
                        e.preventDefault();
                        document.getElementById('searchBox').focus();
                        break;
                    case 'r':
                        e.preventDefault();
                        checkConnectionStatus();
                        break;
                }
            }
        });
        
        // 定期檢查連接狀態
        setInterval(checkConnectionStatus, 30000); // 每30秒檢查一次
    </script>
</body>
</html>